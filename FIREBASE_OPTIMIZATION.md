# Firebase 使用優化指南

## 🚨 問題診斷

您的項目因為超過 Firebase 免費額度（300 信用額度）而被暫停。主要問題是：

### 主要問題：頻繁的 Firebase 寫入操作

在 `review.html` 中，每次學生複習一張字卡時，都會立即調用 `saveUserProgress()` 寫入 Firebase。如果學生複習 100 個字，就會產生 100 次寫入操作！

**Firebase 計費說明：**
- 每次 Firestore 寫入操作 = 1 次寫入
- 每次 Firestore 讀取操作 = 1 次讀取
- 免費額度：每天 50,000 次讀取 + 20,000 次寫入
- 如果超過，會按使用量計費

## ✅ 已實施的優化

### 1. 防抖機制（Debouncing）

在 `review.html` 中實施了防抖機制：
- **之前**：每張卡片立即保存 → 100 張卡片 = 100 次寫入
- **現在**：3 秒內沒有新操作才保存 → 100 張卡片 ≈ 1-3 次寫入

**節省效果**：減少約 95-98% 的寫入操作

### 2. 使用 merge 選項

在 `saveUserProgress()` 中使用 `{ merge: true }`，可以減少不必要的寫入成本。

### 3. 確保完成時保存

在複習完成時，確保所有待保存的進度都會被保存。

## 📋 其他優化建議

### 1. 檢查 Firebase 控制台

1. 登入 [Firebase Console](https://console.firebase.google.com/)
2. 選擇您的項目 `shizi-with-elisa`
3. 查看 **使用量統計**，了解：
   - 每天的讀取/寫入次數
   - 哪些操作消耗最多
   - 是否有異常的使用模式

### 2. 實施本地存儲緩存

`review.html` 中的課程數據已經有緩存機制（30 分鐘），這很好。可以考慮：
- 增加緩存時間（如果數據不常更新）
- 對用戶進度也實施本地緩存，定期同步到 Firebase

### 3. 批量操作

如果有多個操作需要執行，考慮使用批量寫入（batch writes）：
```javascript
const batch = db.batch();
// 添加多個操作
batch.set(ref1, data1);
batch.set(ref2, data2);
await batch.commit(); // 只算一次寫入
```

### 4. 監控和警報

在 Firebase Console 中設置使用量警報，當接近限制時會收到通知。

### 5. 考慮升級計劃

如果您的應用確實需要更多配額，可以考慮：
- Firebase Blaze 計劃（按使用量付費，但有免費配額）
- 或者優化代碼以減少使用量

## 🔍 檢查清單

- [x] 優化 `review.html` 中的保存邏輯（防抖機制）
- [ ] 檢查 Firebase Console 使用量統計
- [ ] 檢查是否有其他頁面也有頻繁寫入的問題
- [ ] 考慮實施用戶進度的本地緩存
- [ ] 設置 Firebase 使用量警報

## 📊 預期效果

實施防抖機制後，預期可以：
- **減少 95-98% 的寫入操作**
- 如果之前每天有 10,000 次寫入，現在可能只有 200-500 次
- 大幅降低 Firebase 使用量，避免超過免費額度

## ⚠️ 注意事項

1. **防抖延遲**：目前設置為 3 秒。如果學生複習速度很快，可能需要調整。
2. **數據保存**：
   - ✅ 已添加頁面關閉時的保存邏輯（`beforeunload` 事件）
   - ⚠️ 注意：由於 Firebase 寫入是異步的，`beforeunload` 可能無法保證 100% 保存成功
   - 💡 建議：如果發現數據丟失，可以考慮減少防抖時間（如改為 1-2 秒）

## 🛠️ 下一步行動

1. **立即行動**：
   - 檢查 Firebase Console，了解具體使用情況
   - 聯繫 Firebase 支持，了解如何恢復項目

2. **短期優化**：
   - 監控使用量，確保不再超過限制
   - 考慮添加頁面關閉時的保存邏輯

3. **長期優化**：
   - 實施更完善的本地緩存機制
   - 考慮使用 IndexedDB 存儲用戶進度
   - 定期審查 Firebase 使用模式

---

**最後更新**：2024年（根據您的計費週期：2月2日 - 3月1日）

