<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è­˜å­—èª²ç¨‹ç®¡ç† Studio</title>
    <link rel="stylesheet" href="../../assets/css/nav-global.css">

    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <!-- Cloudinary Upload Widget -->
    <script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>

    <style>
        /* ==================== CSS Variables (å°é½Š structure.md) ==================== */
        :root {
            /* ä¸»è‰²è°ƒ */
            --primary-color: #0891b2;
            --primary-light: #06b6d4;
            --primary-dark: #0e7490;
            
            /* è¾…åŠ©è‰² */
            --secondary-color: #10b981;
            --accent-color: #f59e0b;
            --danger-color: #ef4444;
            
            /* ä¸­æ€§è‰² */
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-muted: #9ca3af;
            
            /* èƒŒæ™¯è‰² */
            --bg-page: #f9fafb;
            --bg-card: #ffffff;
            --bg-hover: #f3f4f6;
            --bg-light: #e5e7eb;
            
            /* è¾¹æ¡†è‰² */
            --border-light: #e5e7eb;
            --border-medium: #d1d5db;
            --border-dark: #9ca3af;
            
            /* ç‰¹æ®Šç”¨é€” */
            --pinyin-color: #dc2626;
            --character-color: #1f2937;
            --meaning-color: #059669;
            
            /* å­—ä½“ */
            --font-primary: 'Microsoft JhengHei', 'Noto Sans TC', 'PingFang TC', sans-serif;
            --text-base: 1rem;
            --text-lg: 1.125rem;
            --text-xl: 1.25rem;
            --text-2xl: 1.5rem;
            --text-3xl: 2rem;
            --char-size-medium: 2rem;
            --char-size-large: 3rem;
            
            /* é—´è· */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            
            /* åœ†è§’ */
            --radius-sm: 0.25rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            
            /* é˜´å½± */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.15);
            
            /* å­—é‡ */
            --font-normal: 400;
            --font-medium: 500;
            --font-semibold: 600;
            --font-bold: 700;

            /* Studio å°ˆç”¨è®Šæ•¸ */
            --edit-panel-min-width: 5%;
            --edit-panel-max-width: 60%;
            --edit-panel-default-width: 40%;
            --edit-panel-collapsed-width: 60px;
            --resizer-width: 4px;
        }
        
        /* ==================== Global Styles ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--font-primary);
            font-size: var(--text-base);
            color: var(--text-primary);
            background: var(--bg-page);
            line-height: 1.6;
            overflow: hidden;
            height: 100vh;
        }

        /* ==================== Top Navigation ==================== */
        .top-nav {
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        /* ==================== Studio Header ==================== */
        .studio-header {
            background: var(--bg-card);
            padding: var(--spacing-lg) var(--spacing-xl);
            border-bottom: 2px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--spacing-lg);
            flex-wrap: wrap;
        }

        .studio-title {
            font-size: var(--text-2xl);
            font-weight: var(--font-bold);
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .studio-controls {
            display: flex;
            gap: var(--spacing-md);
            flex-wrap: wrap;
            align-items: center;
        }

        /* ==================== æ‰¹é‡å‘å¸ƒæŒ‰é’®ç»„ ==================== */
        .batch-publish-buttons {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .batch-publish-buttons .btn {
            padding: 12px 24px;
            font-size: 1em;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .batch-publish-buttons .btn-success {
            background: var(--secondary-color);
            color: white;
        }

        .batch-publish-buttons .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16,185,129,0.4);
        }

        .batch-publish-buttons .btn-secondary {
            background: var(--text-secondary);
            color: white;
        }

        .batch-publish-buttons .btn-secondary:hover {
            background: #4b5563;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(107,114,128,0.4);
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .control-group label {
            font-weight: var(--font-semibold);
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .control-group select {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: var(--text-base);
            font-family: var(--font-primary);
            background: var(--bg-card);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s;
        }

        .control-group select:hover {
            border-color: var(--primary-color);
        }

        .control-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.1);
        }

        /* ==================== Type Tabs ==================== */
        .type-tabs {
            display: flex;
            gap: var(--spacing-sm);
            border-bottom: 2px solid var(--border-light);
        }

        .type-tab {
            padding: var(--spacing-sm) var(--spacing-lg);
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: var(--text-base);
            font-weight: var(--font-semibold);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-family: var(--font-primary);
        }

        .type-tab:hover:not(:disabled) {
            color: var(--primary-color);
            background: var(--bg-hover);
        }

        .type-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .type-tab:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ==================== Main Container ==================== */
        .studio-container {
            display: flex;
            height: calc(100vh - 140px); /* æ¸›å»å°èˆªå’Œæ¨™é¡Œé«˜åº¦ */
            position: relative;
        }

        /* ==================== Edit Panel ==================== */
        .edit-panel {
            background: var(--bg-card);
            border-right: 2px solid var(--border-light);
            display: flex;
            flex-direction: column;
            width: var(--edit-panel-default-width);
            min-width: var(--edit-panel-min-width);
            max-width: var(--edit-panel-max-width);
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .edit-panel.collapsed {
            width: var(--edit-panel-collapsed-width);
        }

        .edit-panel-header {
            padding: var(--spacing-lg);
            border-bottom: 2px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--primary-color);
            color: white;
            min-height: 60px;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
        }

        .edit-panel-header-left {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            flex: 1;
        }

        .edit-panel-header-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .edit-panel.collapsed .edit-panel-header {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            justify-content: center;
            padding: var(--spacing-md);
        }

        .edit-panel-title {
            font-size: var(--text-xl);
            font-weight: var(--font-bold);
        }

        .edit-panel.collapsed .edit-panel-title {
            font-size: var(--text-base);
        }

        .btn-add,
        .btn-expand-all,
        .btn-collapse-all {
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--text-base);
            font-weight: var(--font-semibold);
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .btn-add:hover,
        .btn-expand-all:hover,
        .btn-collapse-all:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-expand-all,
        .btn-collapse-all {
            padding: var(--spacing-sm) var(--spacing-md);
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--radius-sm);
            font-size: var(--text-base);
            color: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            white-space: nowrap;
            font-weight: var(--font-semibold);
        }

        .btn-expand-all:hover,
        .btn-collapse-all:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.4);
            color: rgba(255, 255, 255, 1);
            transform: none;
            box-shadow: none;
        }

        .edit-panel.collapsed .btn-add,
        .edit-panel.collapsed .btn-expand-all,
        .edit-panel.collapsed .btn-collapse-all {
            display: none;
        }

        .edit-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-lg);
        }

        .edit-panel.collapsed .edit-panel-content {
            display: none;
        }

        /* ==================== Form Item Card ==================== */
        .form-item-card {
            background: var(--bg-light);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: 0;
            margin-bottom: var(--spacing-lg);
            transition: all 0.3s;
            position: relative;
            display: flex;
            align-items: stretch;
        }

        .form-item-card:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-md);
        }

        .form-item-card.dragging {
            opacity: 0.8;
            transform: scale(0.98);
            border-color: var(--primary-dark);
            box-shadow: 0 0 0 2px var(--primary-dark);
            transition: none !important;  /* æ‹–æ‹½æ™‚ç¦ç”¨éæ¸¡å‹•ç•« */
        }

        /* å…¶ä»–å¡ç‰‡å¹³æ»‘è®“ä½ */
        .form-item-card:not(.dragging) {
            transition: transform 0.2s ease-out;
        }

        .form-item-card.collapsed .form-item-content {
            padding: var(--spacing-md) var(--spacing-lg);
        }

        .form-item-card.collapsed .form-item-body {
            display: none;
        }

        .form-item-card.expanded .form-item-content {
            padding: var(--spacing-lg);
        }

        .form-item-card.highlighted {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.2);
            background: rgba(8, 145, 178, 0.05);
        }

        .form-item-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            cursor: pointer;
            user-select: none;
            transition: all 0.3s;
        }

        .form-item-header:hover {
            background: var(--bg-hover);
            border-radius: var(--radius-md);
            padding: var(--spacing-xs);
            margin: calc(-1 * var(--spacing-xs));
        }

        .form-item-card.collapsed .form-item-header {
            margin-bottom: 0;
        }

        .form-item-toggle-icon {
            font-size: var(--text-base);
            color: var(--text-primary);
            background: var(--bg-light);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            padding: var(--spacing-xs) var(--spacing-sm);
            transition: all 0.3s;
            flex-shrink: 0;
            font-weight: var(--font-semibold);
            min-width: 40px;
            text-align: center;
            cursor: pointer;
        }

        .form-item-toggle-icon:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .form-item-card.expanded .form-item-toggle-icon {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .form-item-preview {
            flex: 1;
            text-align: center;
            font-size: 2rem;
            font-weight: var(--font-bold);
            color: var(--character-color);
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .form-item-card.collapsed .form-item-preview {
            font-size: 2rem;
        }

        .form-item-body {
            transition: all 0.3s ease;
        }

        /* å·¦å´æ‹–æ‹½æ¢ */
        .drag-bar {
            width: 12px;
            background: var(--bg-light);
            border-right: 1px solid var(--border-medium);
            border-top-left-radius: var(--radius-lg);
            border-bottom-left-radius: var(--radius-lg);
            cursor: grab;
            user-select: none;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            position: relative;
            z-index: 10;
            pointer-events: auto;
        }

        .drag-bar::before {
            content: 'â‹®';
            font-size: var(--text-xl);
            color: var(--text-muted);
            transition: all 0.2s;
            line-height: 1;
            display: block;
        }

        .drag-bar:hover {
            background: var(--primary-color);
        }

        .drag-bar:hover::before {
            color: white;
        }

        .drag-bar:active {
            cursor: grabbing;
            background: var(--primary-dark);
        }

        .form-item-card.dragging .drag-bar {
            background: var(--primary-dark);
        }

        .form-item-card.dragging .drag-bar::before {
            color: white;
        }

        /* å¡ç‰‡å…§å®¹å€åŸŸ */
        .form-item-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .form-item-title {
            flex: 1;
            font-weight: var(--font-semibold);
            color: var(--text-primary);
        }

        .btn-delete-item {
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--text-base);
            font-weight: var(--font-semibold);
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: var(--spacing-md);
        }

        .btn-delete-item:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .form-item-header .publish-toggle {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            flex-shrink: 0;
        }

        .form-item-header .publish-status {
            font-size: 0.75rem;
            font-weight: var(--font-semibold);
            color: rgba(255, 255, 255, 0.9);
            white-space: nowrap;
        }

        .form-item-header .publish-status.published {
            color: rgba(255, 255, 255, 1);
        }

        .form-item-header .publish-status.unpublished {
            color: rgba(255, 255, 255, 0.6);
        }

        .form-item-header .toggle-switch {
            flex-shrink: 0;
        }

        .form-field {
            margin-bottom: var(--spacing-md);
        }

        .form-field label {
            display: block;
            font-weight: var(--font-semibold);
            margin-bottom: var(--spacing-xs);
            color: var(--text-primary);
            font-size: var(--text-sm);
        }

        .form-field.required label::after {
            content: " *";
            color: var(--danger-color);
        }

        .form-field input,
        .form-field textarea,
        .form-field select {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: var(--text-base);
            font-family: var(--font-primary);
            transition: all 0.3s;
        }

        .form-field input:focus,
        .form-field textarea:focus,
        .form-field select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.1);
        }

        .form-field textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-field small {
            display: block;
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-top: var(--spacing-xs);
        }

        .publish-toggle {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--secondary-color);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* ==================== Resizer ==================== */
        .resizer {
            width: var(--resizer-width);
            background: var(--border-light);
            cursor: col-resize;
            position: relative;
            transition: background 0.3s;
            z-index: 10;
        }

        .resizer:hover {
            background: var(--primary-color);
        }

        .resizer.resizing {
            background: var(--primary-color);
        }

        .resizer::before {
            content: '';
            position: absolute;
            left: -2px;
            right: -2px;
            top: 0;
            bottom: 0;
        }

        /* ==================== Preview Panel ==================== */
        .preview-panel {
            flex: 1;
            background: var(--bg-page);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .preview-panel-header {
            padding: var(--spacing-lg);
            border-bottom: 2px solid var(--border-light);
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .preview-panel-title {
            font-size: var(--text-xl);
            font-weight: var(--font-bold);
            color: var(--primary-color);
        }

        .btn-toggle-edit {
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--text-lg);
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-toggle-edit:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .preview-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-xl);
        }

        /* ==================== Preview Display (é¡ä¼¼ lesson-presentation.html) ==================== */
        .preview-display {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            gap: var(--spacing-xl);
            text-align: left;
            max-width: 1200px;
            margin: 0 auto;
        }

        .preview-display .character {
            font-size: clamp(3.5rem, 7vw, 6rem);
            font-weight: var(--font-bold);
            color: var(--character-color);
            margin: 0;
            padding: 0;
            line-height: 1.1;
        }

        .preview-display .pinyin {
            font-size: clamp(1.5rem, 3vw, 2.4rem);
            color: var(--pinyin-color);
            margin: 0;
            padding: 0;
            font-weight: var(--font-medium);
        }

        .preview-display .meaning {
            font-size: clamp(1.4rem, 2.8vw, 2.2rem);
            color: var(--meaning-color);
            margin: 0;
            padding: 0;
            font-weight: var(--font-semibold);
        }

        .preview-display .breakdown {
            font-size: var(--text-xl);
            color: var(--text-secondary);
            margin: 0;
            padding: var(--spacing-lg);
            background: var(--bg-light);
            border-radius: var(--radius-md);
            width: 100%;
        }

        .preview-display .preview-section {
            width: 100%;
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-lg);
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
        }

        .preview-display .preview-section-title {
            font-size: var(--text-xl);
            font-weight: var(--font-bold);
            color: var(--primary-color);
            margin-bottom: var(--spacing-md);
        }

        .preview-display .preview-section-content {
            font-size: var(--text-lg);
            line-height: 1.8;
            color: var(--text-primary);
        }

        .preview-display .preview-image {
            max-width: 100%;
            max-height: 500px;
            object-fit: contain;
            border-radius: var(--radius-lg);
            margin: var(--spacing-md) 0;
        }

        .preview-display .img-comp {
            width: 120px;
            height: 120px;
            display: inline-block;
            vertical-align: middle;
            object-fit: contain;
            margin: 0 var(--spacing-sm);
            border-radius: var(--radius-md);
        }

        .preview-display .img-origin {
            max-height: 400px;
            width: auto;
            max-width: 100%;
            object-fit: contain;
            display: block;
            margin: var(--spacing-lg) auto;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
        }

        .preview-display .img-story {
            max-height: 500px;
            width: 90%;
            max-width: 100%;
            object-fit: contain;
            display: block;
            margin: var(--spacing-xl) auto;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
        }

        /* å­—å½¢è£œä¸ç³»çµ± (å°é½Š structure.md) */
        .img-comp {
            height: 1.8em;
            width: auto;
            display: inline-block;
            vertical-align: middle;
            margin: 0 4px;
            object-fit: contain;
        }


        /* ==================== Markdown æ¸²æŸ“ ==================== */
        .markdown-content {
            line-height: 1.8;
        }

        .markdown-content img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: var(--spacing-md) auto;
        }

        .markdown-content img.img-origin {
            width: 55%;
            min-width: 180px;
            margin: var(--spacing-lg) auto;
            border: 1px solid var(--border-light);
            padding: var(--spacing-sm);
            background: var(--bg-card);
            border-radius: var(--radius-md);
        }

        .markdown-content img.img-story {
            width: 90%;
            margin: var(--spacing-xl) auto;
            border-radius: var(--radius-lg);
        }

        /* ==================== Status Message ==================== */
        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-md);
            font-weight: var(--font-bold);
            box-shadow: var(--shadow-lg);
            z-index: 4000;
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .status-success {
            background: var(--secondary-color);
            color: white;
        }

        .status-error {
            background: var(--danger-color);
            color: white;
        }

        .status-info {
            background: var(--primary-color);
            color: white;
        }

        /* ==================== Empty State ==================== */
        .empty-state {
            text-align: center;
            padding: var(--spacing-2xl);
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: var(--spacing-lg);
        }

        .empty-state-text {
            font-size: var(--text-lg);
        }

        /* ==================== Responsive ==================== */
        @media (max-width: 1024px) {
            .studio-container {
                flex-direction: column;
            }

            .edit-panel {
                width: 100%;
                max-width: 100%;
                height: 50%;
            }

            .resizer {
                display: none;
            }

            .preview-panel {
                height: 50%;
            }
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="nav-content">
            <a href="../../index.html" class="nav-link">Home</a>
            <span class="nav-separator">|</span>
            <a href="../bct/lessons/lesson.html" class="nav-link">Lessons</a>
            <span class="nav-separator">|</span>
            <a href="lesson.html" class="nav-link">Literacy</a>
            <span class="nav-separator">|</span>
            <a href="review.html" class="nav-link">Review Lit.</a>
            <span class="nav-separator group-separator">â€¢</span>
            <a href="../../pages/grammar.html" class="nav-link">Grammar</a>
            <span class="nav-separator">|</span>
            <a href="../../pages/extras.html" class="nav-link">Extras</a>
            <span class="nav-separator">|</span>
            <a href="../../pages/mini-story.html" class="nav-link">Mini Story</a>
            <span class="nav-separator">|</span>
            <a href="../../pages/music.html" class="nav-link">Music</a>
            <span class="nav-separator group-separator">â€¢</span>
            <a href="../../pages/timeline.html" class="nav-link">Timeline</a>
        </div>
    </nav>

    <!-- Studio Header -->
    <div class="studio-header">
        <div class="studio-title">
            <span>ğŸ“ è­˜å­—èª²ç¨‹ç®¡ç† Studio</span>
        </div>
        <div class="studio-controls">
            <!-- è¯¾æ¬¡é€‰å•åœ¨å·¦ä¾§ -->
            <div class="control-group">
                <label for="lessonSelect">èª²æ¬¡ï¼š</label>
                <select id="lessonSelect">
                    <option value="">-- è«‹é¸æ“‡èª²æ¬¡ --</option>
                    <option value="lesson1">Lesson 1</option>
                    <option value="lesson2">Lesson 2</option>
                    <option value="lesson3">Lesson 3</option>
                    <option value="lesson4">Lesson 4</option>
                    <option value="lesson5">Lesson 5</option>
                    <option value="lesson6">Lesson 6</option>
                    <option value="lesson7">Lesson 7</option>
                    <option value="lesson8">Lesson 8</option>
                    <option value="lesson9">Lesson 9</option>
                    <option value="lesson10">Lesson 10</option>
                    <option value="lesson11">Lesson 11</option>
                    <option value="lesson12">Lesson 12</option>
                    <option value="lesson13">Lesson 13</option>
                    <option value="lesson14">Lesson 14</option>
                    <option value="lesson15">Lesson 15</option>
                    <option value="lesson16">Lesson 16</option>
                    <option value="lesson17">Lesson 17</option>
                    <option value="lesson18">Lesson 18</option>
                    <option value="lesson19">Lesson 19</option>
                    <option value="lesson20">Lesson 20</option>
                    <option value="lesson21">Lesson 21</option>
                    <option value="lesson22">Lesson 22</option>
                    <option value="lesson23">Lesson 23</option>
                    <option value="lesson24">Lesson 24</option>
                    <option value="lesson25">Lesson 25</option>
                </select>
            </div>
            <!-- ç±»å‹Tab -->
            <div class="control-group">
                <div class="type-tabs">
                    <button class="type-tab active" id="tabComponent" data-type="component" disabled>ğŸ§© éƒ¨ä»¶</button>
                    <button class="type-tab" id="tabTarget" data-type="target" disabled>ğŸ¯ ç›®æ¨™å­—</button>
                </div>
            </div>
            <!-- å‘å¸ƒæŒ‰é’®ç»„ -->
            <div class="batch-publish-buttons">
                <button class="btn btn-success" id="btnPublishAll">âœ… æ•´èª²ç™¼å¸ƒ</button>
                <button class="btn btn-secondary" id="btnUnpublishAll">â›” æ•´èª²å–æ¶ˆç™¼å¸ƒ</button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="studio-container">
        <!-- Edit Panel -->
        <div class="edit-panel" id="editPanel">
            <div class="edit-panel-header">
                <div class="edit-panel-header-left">
                    <div class="edit-panel-title">ç·¨è¼¯è¡¨å–®</div>
                </div>
                <div class="edit-panel-header-right">
                    <button class="btn-expand-all" id="btnExpandAll">+ å…¨éƒ¨å±•é–‹</button>
                    <button class="btn-collapse-all" id="btnCollapseAll">- å…¨éƒ¨æ”¶åˆ</button>
                    <button class="btn-add" id="btnAdd">+ æ–°å¢</button>
                </div>
            </div>
            <div class="edit-panel-content" id="editPanelContent">
                <div class="empty-state" id="emptyEditState">
                    <div class="empty-state-icon">ğŸ“</div>
                    <div class="empty-state-text">è«‹é¸æ“‡ç­‰ç´šå’Œé¡å‹é–‹å§‹ç·¨è¼¯</div>
                </div>
                <!-- Form items will be inserted here -->
            </div>
        </div>

        <!-- Resizer -->
        <div class="resizer" id="resizer"></div>

        <!-- Preview Panel -->
        <div class="preview-panel">
            <div class="preview-panel-header">
                <div class="preview-panel-title">å¯¦æ™‚é è¦½</div>
                <button class="btn-toggle-edit" id="btnToggleEdit">â—€</button>
            </div>
            <div class="preview-panel-content" id="previewPanelContent">
                <div class="empty-state" id="emptyPreviewState">
                    <div class="empty-state-icon">ğŸ‘ï¸</div>
                    <div class="empty-state-text">é è¦½å°‡åœ¨æ­¤é¡¯ç¤º</div>
                </div>
                <!-- Preview cards will be inserted here -->
            </div>
        </div>
    </div>


    <script>
        // ==================== Firebase é…ç½® ====================
        const firebaseConfig = {
            apiKey: "AIzaSyDMDTDwDP0mEXwgJdwsXVMB2IFi9Q5zfyU",
            authDomain: "shizi-with-elisa.firebaseapp.com",
            projectId: "shizi-with-elisa",
            storageBucket: "shizi-with-elisa.firebasestorage.app",
            messagingSenderId: "46368268308",
            appId: "1:46368268308:web:5847aeb7b239b16d624701"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        auth.signInAnonymously();

        // ==================== å…¨å±€è®Šæ•¸ ====================
        let currentData = [];
        let currentType = 'component';
        let currentLesson = '';
        let saveTimeout = null;
        let draggedElement = null;
        let clickTimeout = null;
        let lastClickIndex = -1;
        let lastClickTime = 0;
        let isDragging = false;
        let dragHandlersInitialized = false;
        let dragOffsetY = 0;  // æ»‘é¼ åœ¨å¡ç‰‡å…§çš„ Y åç§»
        let dragInitialRect = null;  // åˆå§‹å¡ç‰‡ä½ç½®ä¿¡æ¯
        let currentPlaceholder = null;  // ç•¶å‰ placeholder å…ƒç´ 
        let lastAfterElement = null;  // ä¸Šæ¬¡æ’å…¥ä½ç½®ï¼Œé¿å…é‡è¤‡è¨ˆç®—

        // ==================== å·¥å…·å‡½æ•¸ ====================
        function showMessage(text, type = 'info') {
            const div = document.createElement('div');
            div.className = `status-message status-${type}`;
            div.textContent = text;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 4000);
        }

        function sanitizeData(data) {
            return data.map(item => {
                const clean = {};
                Object.entries(item).forEach(([key, value]) => {
                    if (value !== undefined && value !== '') {
                        clean[key] = value;
                    }
                });
                return clean;
            });
        }

        // å­—å½¢è£œä¸é¡¯ç¤ºé‚è¼¯ï¼ˆå°é½Š structure.mdï¼‰
        function renderCharacterDisplay(char) {
            if (char.display_image && char.display_image.trim()) {
                return `<img src="${char.display_image.trim()}" class="img-comp" alt="comp" onerror="this.style.display='none';">`;
            }
            if (char.character && typeof char.character === 'string' && char.character.trim().toLowerCase().startsWith('http')) {
                return `<img src="${char.character.trim()}" class="img-comp" alt="comp" onerror="this.style.display='none';">`;
            }
            return char.character || '';
        }

        // Markdown æ¸²æŸ“ï¼ˆå°é½Š structure.mdï¼‰
        function renderMarkdown(text) {
            if (!text) return '';
            let html = marked.parse(text);
            // è™•ç†åœ–ç‰‡åˆ†é¡
            html = html.replace(
                /<img src="([^"]+)" alt="--Image of: --([^"]+)"/g,
                (match, src, type) => {
                    return `<img src="${src}" class="img-${type}" alt="${type}" loading="lazy">`;
                }
            );
            return html;
        }

        // é˜²æŠ–ä¿å­˜
        function debounceSave() {
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                saveToFirebase();
            }, 1000);
        }

        // ==================== è¼‰å…¥è³‡æ–™ ====================
        async function loadData() {
            const lesson = document.getElementById('lessonSelect').value;

            if (!lesson) {
                currentData = [];
                currentPreviewIndex = -1;
                currentLesson = '';
                // ç¦ç”¨Tab
                document.getElementById('tabComponent').disabled = true;
                document.getElementById('tabTarget').disabled = true;
                renderEditPanel();
                renderPreviewPanel();
                return;
            }

            // å¯ç”¨Tab
            document.getElementById('tabComponent').disabled = false;
            document.getElementById('tabTarget').disabled = false;

            // å¦‚æœæ²¡æœ‰é€‰æ‹©ç±»å‹ï¼Œä½¿ç”¨å½“å‰ç±»å‹æˆ–é»˜è®¤ç±»å‹
            if (!currentType) {
                currentType = 'component';
                updateTabState('component');
            }

            currentLesson = lesson;

            // åŠ è½½å½“å‰ç±»å‹çš„æ•°æ®
            await loadDataForType(currentType);
        }

        // ==================== åŠ è½½æŒ‡å®šç±»å‹çš„æ•°æ® ====================
        async function loadDataForType(type) {
            if (!currentLesson) {
                currentData = [];
                renderEditPanel();
                renderPreviewPanel();
                return;
            }

            currentType = type;

            try {
                const lessonId = currentLesson;
                const doc = await db.collection('lessons').doc(lessonId).get();
                
                if (doc.exists) {
                    const data = doc.data();
                    const fieldName = type === 'component' ? 'components' : 'target_characters';
                    currentData = data[fieldName] || [];
                    
                    // æŒ‰ order æ’åº
                    currentData.sort((a, b) => (a.order || 0) - (b.order || 0));
                } else {
                    currentData = [];
                }
            } catch (error) {
                showMessage('è¼‰å…¥å¤±æ•—ï¼š' + error.message, 'error');
                currentData = [];
            }

            renderEditPanel();
            renderPreviewPanel(0); // æ˜¾ç¤ºç¬¬ä¸€ä¸ªå­—ç¬¦
        }

        // ==================== æ›´æ–°TabçŠ¶æ€ ====================
        function updateTabState(type) {
            document.querySelectorAll('.type-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const activeTab = document.querySelector(`.type-tab[data-type="${type}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
        }

        // ==================== Tabåˆ‡æ¢ ====================
        async function switchTypeTab(newType) {
            // æ£€æŸ¥æ˜¯å¦å·²é€‰æ‹©è¯¾æ¬¡
            if (!currentLesson) {
                showMessage('è«‹å…ˆé¸æ“‡èª²æ¬¡', 'error');
                return;
            }
            
            // å¦‚æœç±»å‹ç›¸åŒï¼Œä¸åˆ‡æ¢
            if (currentType === newType) return;
            
            // æ ‡è®°æ­£åœ¨åˆ‡æ¢ï¼Œé¿å…æ˜¾ç¤ºè‡ªåŠ¨ä¿å­˜æ¶ˆæ¯
            const activeTab = document.querySelector('.type-tab.active');
            if (activeTab) {
                activeTab.classList.add('switching');
            }
            
            // æ˜¾ç¤ºä¿å­˜æç¤º
            showMessage('ğŸ’¾ æ­£åœ¨ä¿å­˜ä¸¦åˆ‡æ›...', 'info');
            
            try {
                // ç«‹å³ä¿å­˜å½“å‰ç±»å‹çš„æ•°æ®ï¼ˆå¼ºåˆ¶ä¿å­˜ï¼‰
                if (saveTimeout) clearTimeout(saveTimeout);
                
                // åªæœ‰åœ¨æœ‰å½“å‰ç±»å‹ä¸”æœ‰æ•°æ®æ—¶æ‰ä¿å­˜
                if (currentType && currentData.length > 0) {
                    try {
                        await saveToFirebase();
                    } catch (saveError) {
                        console.error('ä¿å­˜å¤±è´¥:', saveError);
                        // ä¿å­˜å¤±è´¥ä¸å½±å“åˆ‡æ¢
                    }
                }
                
                // æ›´æ–°TabçŠ¶æ€
                updateTabState(newType);
                
                // åŠ è½½æ–°ç±»å‹çš„æ•°æ®
                await loadDataForType(newType);
                
                showMessage(`âœ… å·²åˆ‡æ›åˆ°${newType === 'component' ? 'éƒ¨ä»¶' : 'ç›®æ¨™å­—'}`, 'success');
            } catch (error) {
                console.error('Tabåˆ‡æ¢é”™è¯¯:', error);
                showMessage('åˆ‡æ›å¤±æ•—ï¼š' + error.message, 'error');
                // å³ä½¿å¤±è´¥ï¼Œä¹Ÿå°è¯•æ›´æ–°TabçŠ¶æ€å’ŒåŠ è½½æ•°æ®
                try {
                    updateTabState(newType);
                    await loadDataForType(newType);
                } catch (loadError) {
                    console.error('åŠ è½½æ•°æ®å¤±è´¥:', loadError);
                }
            } finally {
                // ç§»é™¤åˆ‡æ¢æ ‡è®°
                if (activeTab) {
                    activeTab.classList.remove('switching');
                }
            }
        }

        // ==================== ä¿å­˜åˆ° Firebase ====================
        async function saveToFirebase() {
            if (!currentLesson || !currentType) return;

            const lessonId = currentLesson;
            const fieldName = currentType === 'component' ? 'components' : 'target_characters';

            try {
                const sanitized = sanitizeData(currentData);
                await db.collection('lessons').doc(lessonId).set({
                    [fieldName]: sanitized,
                    meta: {
                        [`${fieldName}_count`]: sanitized.length,
                        last_updated: firebase.firestore.FieldValue.serverTimestamp()
                    }
                }, { merge: true });
                
                // åªåœ¨éTabåˆ‡æ¢æ—¶æ˜¾ç¤ºè‡ªåŠ¨ä¿å­˜æ¶ˆæ¯ï¼ˆé¿å…å¹²æ‰°ï¼‰
                const activeTab = document.querySelector('.type-tab.active');
                if (!activeTab || !activeTab.classList.contains('switching')) {
                    showMessage('âœ… å·²è‡ªå‹•ä¿å­˜', 'success');
                }
            } catch (error) {
                showMessage('ä¿å­˜å¤±æ•—ï¼š' + error.message, 'error');
                throw error; // æŠ›å‡ºé”™è¯¯ä»¥ä¾¿è°ƒç”¨è€…å¤„ç†
            }
        }

        // ==================== æ¸²æŸ“ç·¨è¼¯é¢æ¿ ====================
        function renderEditPanel() {
            const container = document.getElementById('editPanelContent');
            const emptyState = document.getElementById('emptyEditState');

            if (!container) {
                console.error('editPanelContent not found');
                return;
            }

            if (currentData.length === 0) {
                if (emptyState) emptyState.style.display = 'block';
                container.innerHTML = '';
                return;
            }

            if (emptyState) emptyState.style.display = 'none';
            container.innerHTML = currentData.map((item, index) => createFormItem(item, index)).join('');
            
            // ç¶å®šäº‹ä»¶
            attachFormEvents();
        }

        function createFormItem(item, index) {
            const charDisplay = renderCharacterDisplay(item);
            const isPublished = item.is_published !== false;
            return `
                <div class="form-item-card collapsed" data-index="${index}">
                    <div class="drag-bar"></div>
                    <div class="form-item-content">
                        <div class="form-item-header" onclick="handleFormItemClick(${index})">
                            <span class="form-item-toggle-icon" onclick="event.stopPropagation(); toggleFormItem(${index})">å±•</span>
                            <div class="form-item-preview">${charDisplay || 'æ–°é …ç›®'}</div>
                            <div class="publish-toggle" onclick="event.stopPropagation();">
                                <label class="toggle-switch">
                                    <input type="checkbox" ${isPublished ? 'checked' : ''} onchange="togglePublish(${index}, this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="publish-status ${isPublished ? 'published' : 'unpublished'}">
                                    ${isPublished ? 'å·²ç™¼å¸ƒ' : 'æœªç™¼å¸ƒ'}
                                </span>
                            </div>
                        </div>
                        <div class="form-item-body">
                        <div class="form-field required">
                            <label>å­—</label>
                            <input type="text" data-field="character" value="${item.character || ''}" placeholder="ä¾‹å¦‚ï¼šå¤¬">
                        </div>
                        <div class="form-field">
                            <label>é¡¯ç¤ºåœ–ç‰‡ï¼ˆå­—å½¢è£œä¸ï¼‰</label>
                            <input type="text" data-field="display_image" value="${item.display_image || ''}" placeholder="https://res.cloudinary.com/...">
                            <small>ç•¶å­—ç„¡æ³•æ­£å¸¸é¡¯ç¤ºæ™‚ä½¿ç”¨</small>
                        </div>
                        <div class="form-field required">
                            <label>æ‹¼éŸ³</label>
                            <input type="text" data-field="pinyin" value="${item.pinyin || ''}" placeholder="ä¾‹å¦‚ï¼šguÃ i">
                        </div>
                        <div class="form-field required">
                            <label>æ„æ€ï¼ˆè‹±æ–‡ï¼‰</label>
                            <input type="text" data-field="meaning" value="${item.meaning || ''}" placeholder="ä¾‹å¦‚ï¼što cut apart / separate">
                        </div>
                        <div class="form-field">
                            <label>éƒ¨ä»¶æ‹†è§£</label>
                            <input type="text" data-field="components_breakdown" value="${item.components_breakdown || ''}" placeholder="ä¾‹å¦‚ï¼šãƒ¦ + äºº">
                        </div>
                        <div class="form-field">
                            <label>æ›¸æœ¬è§£é‡‹ï¼ˆæ”¯æ´ Markdownï¼‰</label>
                            <textarea data-field="book_explanation" placeholder="å¯ä½¿ç”¨ Markdown æ ¼å¼...">${item.book_explanation || ''}</textarea>
                        </div>
                        <div class="form-field">
                            <label>è¨˜æ†¶æ•…äº‹ï¼ˆæ”¯æ´ Markdownï¼‰</label>
                            <textarea data-field="story" placeholder="å¯ä½¿ç”¨ Markdown æ ¼å¼...">${item.story || ''}</textarea>
                        </div>
                        <div class="form-field">
                            <label>ç™¼éŸ³æç¤ºï¼ˆæ”¯æ´ Markdownï¼‰</label>
                            <textarea data-field="pronunciation_cue" placeholder="ä¾‹å¦‚ï¼šSounds like **Gwhy**">${item.pronunciation_cue || ''}</textarea>
                        </div>
                        <div class="form-field">
                            <label>åœ–ç‰‡ç¶²å€ï¼ˆè¼”åŠ©æ’åœ–ï¼‰</label>
                            <input type="text" data-field="image" value="${item.image || ''}" placeholder="https://res.cloudinary.com/...">
                            <small>æ•…äº‹åœ–ã€è±¡å½¢æ¼”è®Šåœ–ç­‰</small>
                        </div>
                        <div class="form-field">
                            <label>è©çµ„ç¯„ä¾‹</label>
                            <textarea data-field="phrases" placeholder="ä¾‹å¦‚ï¼šåˆšæ‰ gÄngcÃ¡i (just now)">${item.phrases || ''}</textarea>
                        </div>
                        <div class="form-field">
                            <label>è¨˜æ†¶ä¾‹å¥</label>
                            <input type="text" data-field="example" value="${item.example || ''}" placeholder="ä¾‹å¦‚ï¼šCOW needs a TOWEL">
                        </div>
                        <div class="form-field">
                            <label>æ’åº</label>
                            <input type="number" data-field="order" value="${item.order || index}" min="0">
                        </div>
                        <button class="btn-delete-item" onclick="deleteItem(${index})">ğŸ—‘ï¸ åˆªé™¤æ­¤é …ç›®</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleFormItem(index) {
            const card = document.querySelector(`.form-item-card[data-index="${index}"]`);
            if (card) {
                card.classList.toggle('collapsed');
                card.classList.toggle('expanded');
                // æ›´æ–°æŒ‰é’®æ–‡å­—
                const toggleIcon = card.querySelector('.form-item-toggle-icon');
                if (toggleIcon) {
                    toggleIcon.textContent = card.classList.contains('expanded') ? 'æ”¶' : 'å±•';
                }
            }
        }

        function expandAllItems() {
            document.querySelectorAll('.form-item-card').forEach(card => {
                card.classList.remove('collapsed');
                card.classList.add('expanded');
                const toggleIcon = card.querySelector('.form-item-toggle-icon');
                if (toggleIcon) {
                    toggleIcon.textContent = 'æ”¶';
                }
            });
            showMessage('å·²å±•é–‹æ‰€æœ‰é …ç›®', 'success');
        }

        function collapseAllItems() {
            document.querySelectorAll('.form-item-card').forEach(card => {
                card.classList.remove('expanded');
                card.classList.add('collapsed');
                const toggleIcon = card.querySelector('.form-item-toggle-icon');
                if (toggleIcon) {
                    toggleIcon.textContent = 'å±•';
                }
            });
            showMessage('å·²æŠ˜ç–Šæ‰€æœ‰é …ç›®', 'success');
        }

        function togglePublish(index, checked) {
            if (!currentData[index]) return;
            
            currentData[index].is_published = checked;
            
            // æ›´æ–°ç‹€æ…‹æ–‡å­—é¡¯ç¤º
            const statusText = document.querySelector(`.form-item-card[data-index="${index}"] .publish-status`);
            if (statusText) {
                if (checked) {
                    statusText.classList.add('published');
                    statusText.classList.remove('unpublished');
                    statusText.textContent = 'å·²ç™¼å¸ƒ';
                } else {
                    statusText.classList.remove('published');
                    statusText.classList.add('unpublished');
                    statusText.textContent = 'æœªç™¼å¸ƒ';
                }
            }
            
            debounceSave();
            renderPreviewPanel(currentPreviewIndex >= 0 ? currentPreviewIndex : 0);
            showMessage(checked ? 'å·²ç™¼å¸ƒ' : 'å·²å–æ¶ˆç™¼å¸ƒ', 'success');
        }

        // ==================== æ•´èª²ç™¼å¸ƒ/å–æ¶ˆç™¼å¸ƒ ====================
        async function publishAll() {
            if (!currentLesson) {
                showMessage('è«‹å…ˆé¸æ“‡èª²æ¬¡', 'error');
                return;
            }

            if (currentData.length === 0) {
                showMessage('æ²’æœ‰å¯ç™¼å¸ƒçš„é …ç›®', 'error');
                return;
            }

            if (!confirm(`ç¢ºå®šè¦ç™¼å¸ƒæœ¬èª²çš„æ‰€æœ‰ ${currentData.length} å€‹é …ç›®å—ï¼Ÿ`)) {
                return;
            }

            // æ‰¹é‡è¨­ç½®æ‰€æœ‰é …ç›®ç‚ºå·²ç™¼å¸ƒ
            currentData.forEach((item, index) => {
                item.is_published = true;
                
                // æ›´æ–°UIä¸­çš„checkboxå’Œç‹€æ…‹æ–‡å­—
                const card = document.querySelector(`.form-item-card[data-index="${index}"]`);
                if (card) {
                    const checkbox = card.querySelector('input[type="checkbox"]');
                    const statusText = card.querySelector('.publish-status');
                    
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                    
                    if (statusText) {
                        statusText.classList.add('published');
                        statusText.classList.remove('unpublished');
                        statusText.textContent = 'å·²ç™¼å¸ƒ';
                    }
                }
            });

            // ç«‹å³ä¿å­˜åˆ° Firebaseï¼ˆä¸ä½¿ç”¨é˜²æŠ–ï¼‰
            if (saveTimeout) clearTimeout(saveTimeout);
            await saveToFirebase();
            
            showMessage(`âœ… å·²ç™¼å¸ƒ ${currentData.length} å€‹é …ç›®`, 'success');
        }

        async function unpublishAll() {
            if (!currentLesson) {
                showMessage('è«‹å…ˆé¸æ“‡èª²æ¬¡', 'error');
                return;
            }

            if (currentData.length === 0) {
                showMessage('æ²’æœ‰å¯å–æ¶ˆç™¼å¸ƒçš„é …ç›®', 'error');
                return;
            }

            if (!confirm(`ç¢ºå®šè¦å–æ¶ˆç™¼å¸ƒæœ¬èª²çš„æ‰€æœ‰ ${currentData.length} å€‹é …ç›®å—ï¼Ÿ`)) {
                return;
            }

            // æ‰¹é‡è¨­ç½®æ‰€æœ‰é …ç›®ç‚ºæœªç™¼å¸ƒ
            currentData.forEach((item, index) => {
                item.is_published = false;
                
                // æ›´æ–°UIä¸­çš„checkboxå’Œç‹€æ…‹æ–‡å­—
                const card = document.querySelector(`.form-item-card[data-index="${index}"]`);
                if (card) {
                    const checkbox = card.querySelector('input[type="checkbox"]');
                    const statusText = card.querySelector('.publish-status');
                    
                    if (checkbox) {
                        checkbox.checked = false;
                    }
                    
                    if (statusText) {
                        statusText.classList.remove('published');
                        statusText.classList.add('unpublished');
                        statusText.textContent = 'æœªç™¼å¸ƒ';
                    }
                }
            });

            // ç«‹å³ä¿å­˜åˆ° Firebaseï¼ˆä¸ä½¿ç”¨é˜²æŠ–ï¼‰
            if (saveTimeout) clearTimeout(saveTimeout);
            await saveToFirebase();
            
            showMessage(`âŒ å·²å–æ¶ˆç™¼å¸ƒ ${currentData.length} å€‹é …ç›®`, 'success');
        }

        // ç‚¹å‡»å­—å¡å¤´éƒ¨æ—¶çš„å¤„ç†
        function handleFormItemClick(index) {
            const now = Date.now();
            const card = document.querySelector(`.form-item-card[data-index="${index}"]`);
            
            if (!card) return;
            
            // å¦‚æœæ˜¯åŒä¸€ä¸ªå­—å¡ä¸”åœ¨300mså†…ç‚¹å‡»ï¼Œè§†ä¸ºåŒå‡»ï¼Œå±•å¼€è¡¨å•
            if (lastClickIndex === index && (now - lastClickTime) < 300) {
                // ç¬¬äºŒæ¬¡ç‚¹å‡»ï¼šå±•å¼€è¡¨å•
                toggleFormItem(index);
                lastClickIndex = -1;
                lastClickTime = 0;
            } else {
                // ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼šåªæ˜¾ç¤ºé¢„è§ˆå’Œæ»šåŠ¨ï¼Œä¸å±•å¼€è¡¨å•
                lastClickIndex = index;
                lastClickTime = now;
                
                // é«˜äº®é¡¯ç¤º
                card.classList.add('highlighted');
                // ç§»é™¤å…¶ä»–å¡ç‰‡çš„é«˜äº®
                document.querySelectorAll('.form-item-card').forEach(c => {
                    if (c !== card) c.classList.remove('highlighted');
                });
                // æ»¾å‹•åˆ°è©²ä½ç½®
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // 3ç§’å¾Œç§»é™¤é«˜äº®
                setTimeout(() => {
                    card.classList.remove('highlighted');
                }, 3000);
                
                // æ›´æ–°å³ä¾§é¢„è§ˆ
                renderPreviewPanel(index);
            }
        }

        function scrollToFormItem(index) {
            const card = document.querySelector(`.form-item-card[data-index="${index}"]`);
            if (card) {
                // å±•é–‹å¡ç‰‡
                card.classList.remove('collapsed');
                card.classList.add('expanded');
                // æ›´æ–°æŒ‰é’®æ–‡å­—
                const toggleIcon = card.querySelector('.form-item-toggle-icon');
                if (toggleIcon) {
                    toggleIcon.textContent = 'æ”¶';
                }
                // é«˜äº®é¡¯ç¤º
                card.classList.add('highlighted');
                // ç§»é™¤å…¶ä»–å¡ç‰‡çš„é«˜äº®
                document.querySelectorAll('.form-item-card').forEach(c => {
                    if (c !== card) c.classList.remove('highlighted');
                });
                // æ»¾å‹•åˆ°è©²ä½ç½®
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // 3ç§’å¾Œç§»é™¤é«˜äº®
                setTimeout(() => {
                    card.classList.remove('highlighted');
                }, 3000);
                
                // æ›´æ–°å³ä¾§é¢„è§ˆ
                renderPreviewPanel(index);
            }
        }

        function attachFormEvents() {
            document.querySelectorAll('.form-item-card input, .form-item-card textarea, .form-item-card select').forEach(input => {
                input.addEventListener('input', function() {
                    const card = this.closest('.form-item-card');
                    const index = parseInt(card.dataset.index);
                    const field = this.dataset.field;
                    const value = this.type === 'checkbox' ? this.checked : this.value;
                    
                    if (!currentData[index]) return;
                    
                    // ç§»é™¤ is_published çš„è™•ç†ï¼Œå› ç‚ºç¾åœ¨ç”¨æŒ‰éˆ•è™•ç†
                    if (field !== 'is_published') {
                        currentData[index][field] = value;
                    }
                    
                    // å¦‚æœä¿®æ”¹çš„æ˜¯ character æˆ– display_imageï¼Œæ›´æ–°é è¦½
                    if (field === 'character' || field === 'display_image') {
                        const preview = card.querySelector('.form-item-preview');
                        if (preview) {
                            const item = currentData[index];
                            preview.innerHTML = renderCharacterDisplay(item) || 'æ–°é …ç›®';
                        }
                    }
                    
                    debounceSave();
                    // å¦‚æœä¿®æ”¹çš„æ˜¯å½“å‰é¢„è§ˆçš„å­—ç¬¦ï¼Œæ›´æ–°é¢„è§ˆ
                    if (index === currentPreviewIndex) {
                        renderPreviewPanel(index);
                    }
                });
            });
        }

        // ==================== æ–°å¢é …ç›® ====================
        function addItem() {
            if (!currentLesson) {
                showMessage('è«‹å…ˆé¸æ“‡èª²æ¬¡', 'error');
                return;
            }

            const newItem = {
                character: '',
                pinyin: '',
                meaning: '',
                is_published: false,
                order: currentData.length
            };

            currentData.push(newItem);
            renderEditPanel();
            // è‡ªå‹•å±•é–‹æ–°é …ç›®ä¸¦é¡¯ç¤ºé è¦½
            setTimeout(() => {
                scrollToFormItem(currentData.length - 1);
            }, 100);
            showMessage('å·²æ–°å¢é …ç›®', 'success');
        }

        // ==================== åˆªé™¤é …ç›® ====================
        function deleteItem(index) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é …ç›®ï¼Ÿ')) return;
            
            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é¢„è§ˆçš„å­—ç¬¦ï¼Œåˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªå­—ç¬¦
            if (index === currentPreviewIndex) {
                currentPreviewIndex = 0;
            } else if (index < currentPreviewIndex) {
                currentPreviewIndex--;
            }
            
            currentData.splice(index, 1);
            // é‡æ–°æ’åº
            currentData.forEach((item, i) => {
                item.order = i;
            });
            
            debounceSave();
            renderEditPanel();
            renderPreviewPanel(currentPreviewIndex >= 0 && currentData.length > 0 ? currentPreviewIndex : 0);
            showMessage('å·²åˆªé™¤', 'success');
        }

        // ==================== æ¸²æŸ“é è¦½é¢æ¿ ====================
        let currentPreviewIndex = -1;

        function renderPreviewPanel(index = null) {
            const container = document.getElementById('previewPanelContent');
            const emptyState = document.getElementById('emptyPreviewState');

            if (!container) return;

            if (currentData.length === 0) {
                if (emptyState) emptyState.style.display = 'block';
                container.innerHTML = '';
                return;
            }

            // å¦‚æœæŒ‡å®šäº†indexï¼Œæ˜¾ç¤ºè¯¥å­—ç¬¦ï¼›å¦åˆ™æ˜¾ç¤ºå½“å‰é€‰ä¸­çš„å­—ç¬¦
            const displayIndex = index !== null ? index : (currentPreviewIndex >= 0 ? currentPreviewIndex : 0);
            currentPreviewIndex = displayIndex;
            const item = currentData[displayIndex];

            if (!item) {
                if (emptyState) emptyState.style.display = 'block';
                container.innerHTML = '';
                return;
            }

            if (emptyState) emptyState.style.display = 'none';
            
            // å­—å½¢è£œä¸ç³»çµ±
            let charDisplay = item.character || '';
            if (item.display_image && item.display_image.trim()) {
                charDisplay = `<img src="${item.display_image.trim()}" class="img-comp" alt="comp" onerror="this.style.display='none';">`;
            } else if (item.character && typeof item.character === 'string' && item.character.trim().toLowerCase().startsWith('http')) {
                charDisplay = `<img src="${item.character.trim()}" class="img-comp" alt="comp" onerror="this.style.display='none';">`;
            }

            let html = `
                <div class="preview-display">
                    <div class="character">${charDisplay}</div>
            `;

            // æ‹¼éŸ³
            if (item.pinyin) {
                html += `<div class="pinyin">${item.pinyin}</div>`;
            }

            // æ„æ€
            if (item.meaning) {
                html += `<div class="meaning">${item.meaning}</div>`;
            }

            // éƒ¨ä»¶æ‹†è§£
            if (item.components_breakdown) {
                const processedBreakdown = processMarkdownImages(marked.parse(item.components_breakdown));
                html += `<div class="breakdown">${processedBreakdown}</div>`;
            }

            // åœ–ç‰‡ï¼ˆè¼”åŠ©æ’åœ–ï¼‰
            if (item.image && item.image.trim()) {
                html += `<img src="${item.image.trim()}" class="preview-image" alt="${item.character || 'è¼”åŠ©æ’åœ–'}" onerror="this.style.display='none'">`;
            }

            // æ›¸æœ¬è§£é‡‹
            if (item.book_explanation) {
                const processedExplanation = processMarkdownImages(marked.parse(item.book_explanation));
                html += `
                    <div class="preview-section">
                        <div class="preview-section-title">ğŸ“– è§£é‡‹</div>
                        <div class="preview-section-content markdown-content">${processedExplanation}</div>
                    </div>
                `;
            }

            // è¨˜æ†¶æ•…äº‹
            if (item.story) {
                const processedStory = processMarkdownImages(marked.parse(item.story));
                html += `
                    <div class="preview-section">
                        <div class="preview-section-title">ğŸ§  è¨˜æ†¶æ•…äº‹</div>
                        <div class="preview-section-content markdown-content">${processedStory}</div>
                    </div>
                `;
            }

            // ç™¼éŸ³æç¤º
            if (item.pronunciation_cue) {
                const processedPronunciation = processMarkdownImages(marked.parse(item.pronunciation_cue));
                html += `
                    <div class="preview-section">
                        <div class="preview-section-title">ğŸ”Š ç™¼éŸ³æç¤º</div>
                        <div class="preview-section-content markdown-content">${processedPronunciation}</div>
                    </div>
                `;
            }

            // è©çµ„ç¯„ä¾‹
            if (item.phrases) {
                const processedPhrases = processMarkdownImages(marked.parse(item.phrases));
                html += `
                    <div class="preview-section">
                        <div class="preview-section-title">ğŸ’¬ è©çµ„ç¯„ä¾‹</div>
                        <div class="preview-section-content markdown-content">${processedPhrases}</div>
                    </div>
                `;
            }

            // ä¾‹å¥
            if (item.example) {
                html += `
                    <div class="preview-section">
                        <div class="preview-section-title">ğŸ’¡ ä¾‹å¥</div>
                        <div class="preview-section-content markdown-content">${item.example}</div>
                    </div>
                `;
            }

            html += `</div>`;
            container.innerHTML = html;
            
            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            container.scrollTop = 0;
        }

        // å¤„ç† Markdown å›¾ç‰‡åˆ†ç±»ï¼ˆç±»ä¼¼ lesson-presentation.htmlï¼‰
        function processMarkdownImages(htmlContent) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            const images = tempDiv.querySelectorAll('img');
            images.forEach(img => {
                const alt = (img.getAttribute('alt') || '').toLowerCase();
                if (alt.includes('comp')) {
                    img.className = 'img-comp';
                } else if (alt.includes('origin')) {
                    img.className = 'img-origin';
                } else if (alt.includes('story')) {
                    img.className = 'img-story';
                }
                img.setAttribute('onerror', "this.style.display='none'");
            });
            return tempDiv.innerHTML;
        }


        // ==================== æ‹–æ‹½æ’åº ====================
        // æ‹–æ‹½äº‹ä»¶è™•ç†å‡½æ•¸ï¼ˆå‘½åå‡½æ•¸ï¼Œé¿å…é‡è¤‡ç¶å®šï¼‰
        function handleDragMouseMove(e) {
            if (!isDragging || !draggedElement) return;
            
            e.preventDefault();
            
            const container = document.getElementById('editPanelContent');
            if (!container) return;
            
            const mouseY = e.clientY;
            
            // è®“å¡ç‰‡åœ¨ Y è»¸è·Ÿéš¨æ»‘é¼ 
            if (dragInitialRect) {
                draggedElement.style.position = 'fixed';
                draggedElement.style.left = dragInitialRect.left + 'px';
                draggedElement.style.top = (mouseY - dragOffsetY) + 'px';
                draggedElement.style.width = dragInitialRect.width + 'px';
                draggedElement.style.zIndex = '9999';
                draggedElement.style.pointerEvents = 'none';
            }
            
            // æ‰¾åˆ°æ‡‰è©²æ’å…¥çš„ä½ç½®ï¼ˆåŸºæ–¼æ»‘é¼  Y ä½ç½®ï¼‰
            const afterElement = getDragAfterElement(container, mouseY);
            
            // å¦‚æœæ’å…¥ä½ç½®æ²’æœ‰æ”¹è®Šï¼Œä¸éœ€è¦æ›´æ–°
            if (afterElement === lastAfterElement) return;
            lastAfterElement = afterElement;
            
            // ç§»é™¤èˆŠçš„ placeholder
            if (currentPlaceholder) {
                currentPlaceholder.remove();
                currentPlaceholder = null;
            }
            
            // é‡ç½®æ‰€æœ‰å¡ç‰‡çš„ transform
            container.querySelectorAll('.form-item-card:not(.dragging)').forEach(card => {
                card.style.transform = '';
            });
            
            // å‰µå»ºæ–°çš„ placeholder
            if (dragInitialRect) {
                currentPlaceholder = document.createElement('div');
                currentPlaceholder.style.height = dragInitialRect.height + 'px';
                currentPlaceholder.style.marginBottom = 'var(--spacing-md)';
                currentPlaceholder.className = 'drag-placeholder';
                currentPlaceholder.style.opacity = '0.3';
                currentPlaceholder.style.border = '2px dashed var(--primary-color)';
                currentPlaceholder.style.borderRadius = 'var(--radius-lg)';
                
                if (afterElement == null) {
                    // ç§»å‹•åˆ°æœ€å¾Œ
                    container.appendChild(currentPlaceholder);
                } else {
                    // æ’å…¥åˆ°æŒ‡å®šä½ç½®
                    container.insertBefore(currentPlaceholder, afterElement);
                }
            }
        }
        
        function handleDragMouseUp(e) {
            if (!isDragging || !draggedElement) {
                return;
            }
            
            console.log('âœ… æ‹–æ‹½çµæŸ');
            e.preventDefault();
            
            const container = document.getElementById('editPanelContent');
            if (!container) return;
            
            // æ¢å¾©å¡ç‰‡çš„æ­£å¸¸å®šä½
            draggedElement.style.position = '';
            draggedElement.style.left = '';
            draggedElement.style.top = '';
            draggedElement.style.width = '';
            draggedElement.style.zIndex = '';
            draggedElement.style.pointerEvents = '';
            
            // é‡ç½®å…¶ä»–å¡ç‰‡çš„ transform
            container.querySelectorAll('.form-item-card:not(.dragging)').forEach(card => {
                card.style.transform = '';
            });
            
            // å¦‚æœæœ‰ placeholderï¼Œå°‡å¡ç‰‡æ’å…¥åˆ° placeholder çš„ä½ç½®
            if (currentPlaceholder) {
                const placeholderIndex = Array.from(container.children).indexOf(currentPlaceholder);
                container.insertBefore(draggedElement, currentPlaceholder);
                currentPlaceholder.remove();
                currentPlaceholder = null;
                
                // è¨ˆç®—æ–°ä½ç½®
                const newIndex = Array.from(container.children).indexOf(draggedElement);
                const oldIndex = parseInt(draggedElement.dataset.index);
                
                console.log('ä½ç½®è®ŠåŒ–:', { oldIndex, newIndex });
                
                if (oldIndex !== newIndex && newIndex >= 0) {
                    // æ›´æ–°è³‡æ–™é †åº
                    const [movedItem] = currentData.splice(oldIndex, 1);
                    currentData.splice(newIndex, 0, movedItem);
                    
                    // æ›´æ–° order
                    currentData.forEach((item, i) => {
                        item.order = i;
                    });
                    
                    debounceSave();
                    renderEditPanel();
                    renderPreviewPanel(currentPreviewIndex >= 0 ? currentPreviewIndex : 0);
                }
            }
            
            // ç§»é™¤æ‹–æ‹½æ¨£å¼
            draggedElement.classList.remove('dragging');
            
            // é‡ç½®ç‹€æ…‹
            isDragging = false;
            draggedElement = null;
            dragOffsetY = 0;
            dragInitialRect = null;
            lastAfterElement = null;
            document.body.style.userSelect = '';
            document.body.style.cursor = '';
        }
        
        function initDragAndDrop() {
            const container = document.getElementById('editPanelContent');
            if (!container) return;
            
            // åªåˆå§‹åŒ–ä¸€æ¬¡å…¨å±€äº‹ä»¶ç›£è½å™¨
            if (!dragHandlersInitialized) {
                document.addEventListener('mousemove', handleDragMouseMove);
                document.addEventListener('mouseup', handleDragMouseUp);
                dragHandlersInitialized = true;
            }
            
            // ä½¿ç”¨äº‹ä»¶å§”æ´¾ï¼Œåªåœ¨æ‹–æ‹½æ¢ä¸Šç›£è½ mousedown
            // ä½¿ç”¨ capture éšæ®µç¢ºä¿å„ªå…ˆè™•ç†
            container.addEventListener('mousedown', (e) => {
                // å…ˆæª¢æŸ¥æ˜¯å¦ç›´æ¥é»æ“Šåœ¨æ‹–æ‹½æ¢ä¸Š
                const dragBar = e.target.closest('.drag-bar');
                const card = e.target.closest('.form-item-card');
                
                if (!card) return;
                
                // æ–¹æ³•1: å¦‚æœç›´æ¥é»æ“Šåœ¨æ‹–æ‹½æ¢ä¸Š
                if (dragBar) {
                    console.log('âœ… æ‹–æ‹½é–‹å§‹ (ç›´æ¥é»æ“Šæ‹–æ‹½æ¢)');
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    
                    isDragging = true;
                    draggedElement = card;
                    
                    // è¨˜éŒ„åˆå§‹ä½ç½®å’Œåç§»
                    const cardRect = card.getBoundingClientRect();
                    dragInitialRect = {
                        left: cardRect.left,
                        top: cardRect.top,
                        width: cardRect.width,
                        height: cardRect.height
                    };
                    dragOffsetY = e.clientY - cardRect.top;
                    
                    // æ·»åŠ æ‹–æ‹½æ¨£å¼
                    card.classList.add('dragging');
                    
                    // é˜²æ­¢æ–‡å­—é¸æ“‡
                    document.body.style.userSelect = 'none';
                    document.body.style.cursor = 'grabbing';
                    return;
                }
                
                // æ–¹æ³•2: æª¢æŸ¥é»æ“Šä½ç½®æ˜¯å¦åœ¨æ‹–æ‹½æ¢å…§ï¼ˆå·¦å´12pxç¯„åœå…§ï¼‰
                const cardRect = card.getBoundingClientRect();
                const clickX = e.clientX - cardRect.left;
                
                console.log('æ‹–æ‹½æª¢æ¸¬:', {
                    clickX: clickX,
                    cardLeft: cardRect.left,
                    clientX: e.clientX,
                    target: e.target.tagName,
                    targetClass: e.target.className,
                    hasDragBar: !!dragBar
                });
                
                // å¦‚æœé»æ“Šåœ¨å·¦å´12pxç¯„åœå…§ï¼Œå‰‡è¦–ç‚ºæ‹–æ‹½æ¢é»æ“Š
                if (clickX <= 12) {
                    console.log('âœ… æ‹–æ‹½é–‹å§‹ (ä½ç½®æª¢æ¸¬)');
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    
                    isDragging = true;
                    draggedElement = card;
                    
                    // è¨˜éŒ„åˆå§‹ä½ç½®å’Œåç§»
                    dragInitialRect = {
                        left: cardRect.left,
                        top: cardRect.top,
                        width: cardRect.width,
                        height: cardRect.height
                    };
                    dragOffsetY = e.clientY - cardRect.top;
                    
                    // æ·»åŠ æ‹–æ‹½æ¨£å¼
                    card.classList.add('dragging');
                    
                    // é˜²æ­¢æ–‡å­—é¸æ“‡
                    document.body.style.userSelect = 'none';
                    document.body.style.cursor = 'grabbing';
                }
            }, true); // ä½¿ç”¨ capture éšæ®µ
        }

        function getDragAfterElement(container, mouseY) {
            // æ’é™¤æ‹–æ‹½ä¸­çš„å¡ç‰‡å’Œ placeholder
            const draggableElements = [...container.querySelectorAll('.form-item-card:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = mouseY - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // ==================== é¢æ¿å¯¬åº¦èª¿æ•´ ====================
        function initResizer() {
            const resizer = document.getElementById('resizer');
            const editPanel = document.getElementById('editPanel');
            let isResizing = false;

            resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                resizer.classList.add('resizing');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;

                const containerRect = document.querySelector('.studio-container').getBoundingClientRect();
                const newWidth = ((e.clientX - containerRect.left) / containerRect.width) * 100;
                
                if (newWidth >= 5 && newWidth <= 60) {
                    editPanel.style.width = `${newWidth}%`;
                }
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    resizer.classList.remove('resizing');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        }

        // ==================== åˆ‡æ›ç·¨è¼¯é¢æ¿ ====================
        function initToggleEdit() {
            const btn = document.getElementById('btnToggleEdit');
            const editPanel = document.getElementById('editPanel');

            btn.addEventListener('click', () => {
                editPanel.classList.toggle('collapsed');
                btn.textContent = editPanel.classList.contains('collapsed') ? 'â–¶' : 'â—€';
            });
        }


        // ==================== åˆå§‹åŒ– ====================
        // Tabåˆ‡æ¢äº‹ä»¶
        document.querySelectorAll('.type-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                if (!tab.disabled) {
                    const type = tab.dataset.type;
                    switchTypeTab(type);
                }
            });
        });
        
        document.getElementById('lessonSelect').addEventListener('change', loadData);
        document.getElementById('btnAdd').addEventListener('click', addItem);
        document.getElementById('btnExpandAll').addEventListener('click', expandAllItems);
        document.getElementById('btnCollapseAll').addEventListener('click', collapseAllItems);
        document.getElementById('btnPublishAll').addEventListener('click', publishAll);
        document.getElementById('btnUnpublishAll').addEventListener('click', unpublishAll);
        initResizer();
        initToggleEdit();
        initDragAndDrop();

        // è¼‰å…¥å…¨åŸŸå°èˆªè…³æœ¬
        const navScript = document.createElement('script');
        navScript.src = '../../assets/js/nav-global.js';
        document.body.appendChild(navScript);
    </script>
</body>
</html>
