<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ë≠òÂ≠óË™≤Á®ãÁÆ°ÁêÜ Studio</title>
    <link rel="stylesheet" href="../../assets/css/nav-global.css">

    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <!-- Cloudinary Upload Widget -->
    <script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>

    <style>
        /* ==================== CSS Variables (Â∞çÈΩä structure.md) ==================== */
        :root {
            /* ‰∏ªËâ≤Ë∞É */
            --primary-color: #0891b2;
            --primary-light: #06b6d4;
            --primary-dark: #0e7490;
            
            /* ËæÖÂä©Ëâ≤ */
            --secondary-color: #10b981;
            --accent-color: #f59e0b;
            --danger-color: #ef4444;
            
            /* ‰∏≠ÊÄßËâ≤ */
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-muted: #9ca3af;
            
            /* ËÉåÊôØËâ≤ */
            --bg-page: #f9fafb;
            --bg-card: #ffffff;
            --bg-hover: #f3f4f6;
            --bg-light: #e5e7eb;
            
            /* ËæπÊ°ÜËâ≤ */
            --border-light: #e5e7eb;
            --border-medium: #d1d5db;
            --border-dark: #9ca3af;
            
            /* ÁâπÊÆäÁî®ÈÄî */
            --pinyin-color: #dc2626;
            --character-color: #1f2937;
            --meaning-color: #059669;
            
            /* Â≠ó‰Ωì */
            --font-primary: 'Microsoft JhengHei', 'Noto Sans TC', 'PingFang TC', sans-serif;
            --text-base: 1rem;
            --text-lg: 1.125rem;
            --text-xl: 1.25rem;
            --text-2xl: 1.5rem;
            --text-3xl: 2rem;
            --char-size-medium: 2rem;
            --char-size-large: 3rem;
            
            /* Èó¥Ë∑ù */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            
            /* ÂúÜËßí */
            --radius-sm: 0.25rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            
            /* Èò¥ÂΩ± */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.15);
            
            /* Â≠óÈáç */
            --font-normal: 400;
            --font-medium: 500;
            --font-semibold: 600;
            --font-bold: 700;

            /* Studio Â∞àÁî®ËÆäÊï∏ */
            --edit-panel-min-width: 5%;
            --edit-panel-max-width: 60%;
            --edit-panel-default-width: 40%;
            --edit-panel-collapsed-width: 60px;
            --resizer-width: 4px;
        }
        
        /* ==================== Global Styles ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--font-primary);
            font-size: var(--text-base);
            color: var(--text-primary);
            background: var(--bg-page);
            line-height: 1.6;
            overflow: hidden;
            height: 100vh;
        }

        /* ==================== Top Navigation ==================== */
        .top-nav {
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        /* ==================== Studio Header ==================== */
        .studio-header {
            background: var(--bg-card);
            padding: var(--spacing-lg) var(--spacing-xl);
            border-bottom: 2px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--spacing-lg);
            flex-wrap: wrap;
        }

        .studio-title {
            font-size: var(--text-2xl);
            font-weight: var(--font-bold);
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .studio-controls {
            display: flex;
            gap: var(--spacing-md);
            flex-wrap: wrap;
            align-items: center;
        }

        /* ==================== ÊâπÈáèÂèëÂ∏ÉÊåâÈíÆÁªÑ ==================== */
        .batch-publish-buttons {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .batch-publish-buttons .btn {
            padding: 12px 24px;
            font-size: 1em;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .batch-publish-buttons .btn-success {
            background: var(--secondary-color);
            color: white;
        }

        .batch-publish-buttons .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16,185,129,0.4);
        }

        .batch-publish-buttons .btn-secondary {
            background: var(--text-secondary);
            color: white;
        }

        .batch-publish-buttons .btn-secondary:hover {
            background: #4b5563;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(107,114,128,0.4);
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .control-group label {
            font-weight: var(--font-semibold);
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .control-group select {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: var(--text-base);
            font-family: var(--font-primary);
            background: var(--bg-card);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s;
        }

        .control-group select:hover {
            border-color: var(--primary-color);
        }

        .control-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.1);
        }

        /* ==================== Type Tabs ==================== */
        .type-tabs {
            display: flex;
            gap: var(--spacing-sm);
            border-bottom: 2px solid var(--border-light);
        }

        .type-tab {
            padding: var(--spacing-sm) var(--spacing-lg);
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: var(--text-base);
            font-weight: var(--font-semibold);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-family: var(--font-primary);
        }

        .type-tab:hover:not(:disabled) {
            color: var(--primary-color);
            background: var(--bg-hover);
        }

        .type-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .type-tab:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ==================== Main Container ==================== */
        .studio-container {
            display: flex;
            height: calc(100vh - 140px); /* Ê∏õÂéªÂ∞éËà™ÂíåÊ®ôÈ°åÈ´òÂ∫¶ */
            position: relative;
        }

        /* ==================== Edit Panel ==================== */
        .edit-panel {
            background: var(--bg-card);
            border-right: 2px solid var(--border-light);
            display: flex;
            flex-direction: column;
            width: var(--edit-panel-default-width);
            min-width: var(--edit-panel-min-width);
            max-width: var(--edit-panel-max-width);
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .edit-panel.collapsed {
            width: var(--edit-panel-collapsed-width);
        }

        .edit-panel-header {
            padding: var(--spacing-lg);
            border-bottom: 2px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--primary-color);
            color: white;
            min-height: 60px;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
        }

        .edit-panel-header-left {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            flex: 1;
        }

        .edit-panel-header-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .edit-panel.collapsed .edit-panel-header {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            justify-content: center;
            padding: var(--spacing-md);
        }

        .edit-panel-title {
            font-size: var(--text-xl);
            font-weight: var(--font-bold);
        }

        .edit-panel.collapsed .edit-panel-title {
            font-size: var(--text-base);
        }

        .btn-add,
        .btn-expand-all,
        .btn-collapse-all {
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--text-base);
            font-weight: var(--font-semibold);
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .btn-add:hover,
        .btn-expand-all:hover,
        .btn-collapse-all:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-expand-all,
        .btn-collapse-all {
            padding: var(--spacing-sm) var(--spacing-md);
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--radius-sm);
            font-size: var(--text-base);
            color: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            white-space: nowrap;
            font-weight: var(--font-semibold);
        }

        .btn-expand-all:hover,
        .btn-collapse-all:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.4);
            color: rgba(255, 255, 255, 1);
            transform: none;
            box-shadow: none;
        }

        .edit-panel.collapsed .btn-add,
        .edit-panel.collapsed .btn-expand-all,
        .edit-panel.collapsed .btn-collapse-all {
            display: none;
        }

        .edit-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-lg);
        }

        .edit-panel.collapsed .edit-panel-content {
            display: none;
        }

        /* ==================== Form Item Card ==================== */
        .form-item-card {
            background: var(--bg-light);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            transition: all 0.3s;
            position: relative;
        }

        .form-item-card:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-md);
        }

        .form-item-card.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .form-item-card.collapsed {
            padding: var(--spacing-md) var(--spacing-lg);
        }

        .form-item-card.collapsed .form-item-body {
            display: none;
        }

        .form-item-card.expanded {
            padding: var(--spacing-lg);
        }

        .form-item-card.highlighted {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.2);
            background: rgba(8, 145, 178, 0.05);
        }

        .form-item-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            cursor: pointer;
            user-select: none;
            transition: all 0.3s;
        }

        .form-item-header:hover {
            background: var(--bg-hover);
            border-radius: var(--radius-md);
            padding: var(--spacing-xs);
            margin: calc(-1 * var(--spacing-xs));
        }

        .form-item-card.collapsed .form-item-header {
            margin-bottom: 0;
        }

        .form-item-toggle-icon {
            font-size: var(--text-base);
            color: var(--text-primary);
            background: var(--bg-light);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            padding: var(--spacing-xs) var(--spacing-sm);
            transition: all 0.3s;
            flex-shrink: 0;
            font-weight: var(--font-semibold);
            min-width: 40px;
            text-align: center;
            cursor: pointer;
        }

        .form-item-toggle-icon:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .form-item-card.expanded .form-item-toggle-icon {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .form-item-preview {
            flex: 1;
            text-align: center;
            font-size: 2rem;
            font-weight: var(--font-bold);
            color: var(--character-color);
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .form-item-card.collapsed .form-item-preview {
            font-size: 2rem;
        }

        .form-item-body {
            transition: all 0.3s ease;
        }

        .drag-handle {
            font-size: var(--text-xl);
            color: var(--text-muted);
            cursor: grab;
            user-select: none;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .form-item-title {
            flex: 1;
            font-weight: var(--font-semibold);
            color: var(--text-primary);
        }

        .btn-delete-item {
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--text-base);
            font-weight: var(--font-semibold);
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: var(--spacing-md);
        }

        .btn-delete-item:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .form-item-header .publish-toggle {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            flex-shrink: 0;
        }

        .form-item-header .publish-status {
            font-size: 0.75rem;
            font-weight: var(--font-semibold);
            color: rgba(255, 255, 255, 0.9);
            white-space: nowrap;
        }

        .form-item-header .publish-status.published {
            color: rgba(255, 255, 255, 1);
        }

        .form-item-header .publish-status.unpublished {
            color: rgba(255, 255, 255, 0.6);
        }

        .form-item-header .toggle-switch {
            flex-shrink: 0;
        }

        .form-field {
            margin-bottom: var(--spacing-md);
        }

        .form-field label {
            display: block;
            font-weight: var(--font-semibold);
            margin-bottom: var(--spacing-xs);
            color: var(--text-primary);
            font-size: var(--text-sm);
        }

        .form-field.required label::after {
            content: " *";
            color: var(--danger-color);
        }

        .form-field input,
        .form-field textarea,
        .form-field select {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: var(--text-base);
            font-family: var(--font-primary);
            transition: all 0.3s;
        }

        .form-field input:focus,
        .form-field textarea:focus,
        .form-field select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.1);
        }

        .form-field textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-field small {
            display: block;
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-top: var(--spacing-xs);
        }

        .publish-toggle {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--secondary-color);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* ==================== Resizer ==================== */
        .resizer {
            width: var(--resizer-width);
            background: var(--border-light);
            cursor: col-resize;
            position: relative;
            transition: background 0.3s;
            z-index: 10;
        }

        .resizer:hover {
            background: var(--primary-color);
        }

        .resizer.resizing {
            background: var(--primary-color);
        }

        .resizer::before {
            content: '';
            position: absolute;
            left: -2px;
            right: -2px;
            top: 0;
            bottom: 0;
        }

        /* ==================== Preview Panel ==================== */
        .preview-panel {
            flex: 1;
            background: var(--bg-page);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .preview-panel-header {
            padding: var(--spacing-lg);
            border-bottom: 2px solid var(--border-light);
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .preview-panel-title {
            font-size: var(--text-xl);
            font-weight: var(--font-bold);
            color: var(--primary-color);
        }

        .btn-toggle-edit {
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--text-lg);
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-toggle-edit:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .preview-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-xl);
        }

        /* ==================== Preview Display (È°û‰ºº lesson-presentation.html) ==================== */
        .preview-display {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            gap: var(--spacing-xl);
            text-align: left;
            max-width: 1200px;
            margin: 0 auto;
        }

        .preview-display .character {
            font-size: clamp(3.5rem, 7vw, 6rem);
            font-weight: var(--font-bold);
            color: var(--character-color);
            margin: 0;
            padding: 0;
            line-height: 1.1;
        }

        .preview-display .pinyin {
            font-size: clamp(1.5rem, 3vw, 2.4rem);
            color: var(--pinyin-color);
            margin: 0;
            padding: 0;
            font-weight: var(--font-medium);
        }

        .preview-display .meaning {
            font-size: clamp(1.4rem, 2.8vw, 2.2rem);
            color: var(--meaning-color);
            margin: 0;
            padding: 0;
            font-weight: var(--font-semibold);
        }

        .preview-display .breakdown {
            font-size: var(--text-xl);
            color: var(--text-secondary);
            margin: 0;
            padding: var(--spacing-lg);
            background: var(--bg-light);
            border-radius: var(--radius-md);
            width: 100%;
        }

        .preview-display .preview-section {
            width: 100%;
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-lg);
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
        }

        .preview-display .preview-section-title {
            font-size: var(--text-xl);
            font-weight: var(--font-bold);
            color: var(--primary-color);
            margin-bottom: var(--spacing-md);
        }

        .preview-display .preview-section-content {
            font-size: var(--text-lg);
            line-height: 1.8;
            color: var(--text-primary);
        }

        .preview-display .preview-image {
            max-width: 100%;
            max-height: 500px;
            object-fit: contain;
            border-radius: var(--radius-lg);
            margin: var(--spacing-md) 0;
        }

        .preview-display .img-comp {
            width: 120px;
            height: 120px;
            display: inline-block;
            vertical-align: middle;
            object-fit: contain;
            margin: 0 var(--spacing-sm);
            border-radius: var(--radius-md);
        }

        .preview-display .img-origin {
            max-height: 400px;
            width: auto;
            max-width: 100%;
            object-fit: contain;
            display: block;
            margin: var(--spacing-lg) auto;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
        }

        .preview-display .img-story {
            max-height: 500px;
            width: 90%;
            max-width: 100%;
            object-fit: contain;
            display: block;
            margin: var(--spacing-xl) auto;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
        }

        /* Â≠óÂΩ¢Ë£ú‰∏ÅÁ≥ªÁµ± (Â∞çÈΩä structure.md) */
        .img-comp {
            height: 1.8em;
            width: auto;
            display: inline-block;
            vertical-align: middle;
            margin: 0 4px;
            object-fit: contain;
        }


        /* ==================== Markdown Ê∏≤Êüì ==================== */
        .markdown-content {
            line-height: 1.8;
        }

        .markdown-content img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: var(--spacing-md) auto;
        }

        .markdown-content img.img-origin {
            width: 55%;
            min-width: 180px;
            margin: var(--spacing-lg) auto;
            border: 1px solid var(--border-light);
            padding: var(--spacing-sm);
            background: var(--bg-card);
            border-radius: var(--radius-md);
        }

        .markdown-content img.img-story {
            width: 90%;
            margin: var(--spacing-xl) auto;
            border-radius: var(--radius-lg);
        }

        /* ==================== Status Message ==================== */
        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-md);
            font-weight: var(--font-bold);
            box-shadow: var(--shadow-lg);
            z-index: 4000;
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .status-success {
            background: var(--secondary-color);
            color: white;
        }

        .status-error {
            background: var(--danger-color);
            color: white;
        }

        .status-info {
            background: var(--primary-color);
            color: white;
        }

        /* ==================== Empty State ==================== */
        .empty-state {
            text-align: center;
            padding: var(--spacing-2xl);
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: var(--spacing-lg);
        }

        .empty-state-text {
            font-size: var(--text-lg);
        }

        /* ==================== Responsive ==================== */
        @media (max-width: 1024px) {
            .studio-container {
                flex-direction: column;
            }

            .edit-panel {
                width: 100%;
                max-width: 100%;
                height: 50%;
            }

            .resizer {
                display: none;
            }

            .preview-panel {
                height: 50%;
            }
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="nav-content">
            <a href="../../index.html" class="nav-link">Home</a>
            <span class="nav-separator">|</span>
            <a href="../bct/lessons/lesson.html" class="nav-link">Lessons</a>
            <span class="nav-separator">|</span>
            <a href="lesson.html" class="nav-link">Literacy</a>
            <span class="nav-separator">|</span>
            <a href="review.html" class="nav-link">Review Lit.</a>
            <span class="nav-separator group-separator">‚Ä¢</span>
            <a href="../../pages/grammar.html" class="nav-link">Grammar</a>
            <span class="nav-separator">|</span>
            <a href="../../pages/extras.html" class="nav-link">Extras</a>
            <span class="nav-separator">|</span>
            <a href="../../pages/mini-story.html" class="nav-link">Mini Story</a>
            <span class="nav-separator">|</span>
            <a href="../../pages/music.html" class="nav-link">Music</a>
            <span class="nav-separator group-separator">‚Ä¢</span>
            <a href="../../pages/timeline.html" class="nav-link">Timeline</a>
        </div>
    </nav>

    <!-- Studio Header -->
    <div class="studio-header">
        <div class="studio-title">
            <span>üéì Ë≠òÂ≠óË™≤Á®ãÁÆ°ÁêÜ Studio</span>
        </div>
        <div class="studio-controls">
            <!-- ËØæÊ¨°ÈÄâÂçïÂú®Â∑¶‰æß -->
            <div class="control-group">
                <label for="lessonSelect">Ë™≤Ê¨°Ôºö</label>
                <select id="lessonSelect">
                    <option value="">-- Ë´ãÈÅ∏ÊìáË™≤Ê¨° --</option>
                    <option value="lesson1">Lesson 1</option>
                    <option value="lesson2">Lesson 2</option>
                    <option value="lesson3">Lesson 3</option>
                    <option value="lesson4">Lesson 4</option>
                    <option value="lesson5">Lesson 5</option>
                    <option value="lesson6">Lesson 6</option>
                    <option value="lesson7">Lesson 7</option>
                    <option value="lesson8">Lesson 8</option>
                    <option value="lesson9">Lesson 9</option>
                    <option value="lesson10">Lesson 10</option>
                    <option value="lesson11">Lesson 11</option>
                    <option value="lesson12">Lesson 12</option>
                    <option value="lesson13">Lesson 13</option>
                    <option value="lesson14">Lesson 14</option>
                    <option value="lesson15">Lesson 15</option>
                    <option value="lesson16">Lesson 16</option>
                    <option value="lesson17">Lesson 17</option>
                    <option value="lesson18">Lesson 18</option>
                    <option value="lesson19">Lesson 19</option>
                    <option value="lesson20">Lesson 20</option>
                    <option value="lesson21">Lesson 21</option>
                    <option value="lesson22">Lesson 22</option>
                    <option value="lesson23">Lesson 23</option>
                    <option value="lesson24">Lesson 24</option>
                    <option value="lesson25">Lesson 25</option>
                </select>
            </div>
            <!-- Á±ªÂûãTab -->
            <div class="control-group">
                <div class="type-tabs">
                    <button class="type-tab active" id="tabComponent" data-type="component" disabled>üß© ÈÉ®‰ª∂</button>
                    <button class="type-tab" id="tabTarget" data-type="target" disabled>üéØ ÁõÆÊ®ôÂ≠ó</button>
                </div>
            </div>
            <!-- ÂèëÂ∏ÉÊåâÈíÆÁªÑ -->
            <div class="batch-publish-buttons">
                <button class="btn btn-success" id="btnPublishAll">‚úÖ Êï¥Ë™≤ÁôºÂ∏É</button>
                <button class="btn btn-secondary" id="btnUnpublishAll">‚õî Êï¥Ë™≤ÂèñÊ∂àÁôºÂ∏É</button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="studio-container">
        <!-- Edit Panel -->
        <div class="edit-panel" id="editPanel">
            <div class="edit-panel-header">
                <div class="edit-panel-header-left">
                    <div class="edit-panel-title">Á∑®ËºØË°®ÂñÆ</div>
                </div>
                <div class="edit-panel-header-right">
                    <button class="btn-expand-all" id="btnExpandAll">+ ÂÖ®ÈÉ®Â±ïÈñã</button>
                    <button class="btn-collapse-all" id="btnCollapseAll">- ÂÖ®ÈÉ®Êî∂Âêà</button>
                    <button class="btn-add" id="btnAdd">+ Êñ∞Â¢û</button>
                </div>
            </div>
            <div class="edit-panel-content" id="editPanelContent">
                <div class="empty-state" id="emptyEditState">
                    <div class="empty-state-icon">üìù</div>
                    <div class="empty-state-text">Ë´ãÈÅ∏ÊìáÁ≠âÁ¥öÂíåÈ°ûÂûãÈñãÂßãÁ∑®ËºØ</div>
                </div>
                <!-- Form items will be inserted here -->
            </div>
        </div>

        <!-- Resizer -->
        <div class="resizer" id="resizer"></div>

        <!-- Preview Panel -->
        <div class="preview-panel">
            <div class="preview-panel-header">
                <div class="preview-panel-title">ÂØ¶ÊôÇÈ†êË¶Ω</div>
                <button class="btn-toggle-edit" id="btnToggleEdit">‚óÄ</button>
            </div>
            <div class="preview-panel-content" id="previewPanelContent">
                <div class="empty-state" id="emptyPreviewState">
                    <div class="empty-state-icon">üëÅÔ∏è</div>
                    <div class="empty-state-text">È†êË¶ΩÂ∞áÂú®Ê≠§È°ØÁ§∫</div>
                </div>
                <!-- Preview cards will be inserted here -->
            </div>
        </div>
    </div>


    <script>
        // ==================== Firebase ÈÖçÁΩÆ ====================
        const firebaseConfig = {
            apiKey: "AIzaSyDMDTDwDP0mEXwgJdwsXVMB2IFi9Q5zfyU",
            authDomain: "shizi-with-elisa.firebaseapp.com",
            projectId: "shizi-with-elisa",
            storageBucket: "shizi-with-elisa.firebasestorage.app",
            messagingSenderId: "46368268308",
            appId: "1:46368268308:web:5847aeb7b239b16d624701"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        auth.signInAnonymously();

        // ==================== ÂÖ®Â±ÄËÆäÊï∏ ====================
        let currentData = [];
        let currentType = 'component';
        let currentLesson = '';
        let saveTimeout = null;
        let draggedElement = null;
        let clickTimeout = null;
        let lastClickIndex = -1;
        let lastClickTime = 0;

        // ==================== Â∑•ÂÖ∑ÂáΩÊï∏ ====================
        function showMessage(text, type = 'info') {
            const div = document.createElement('div');
            div.className = `status-message status-${type}`;
            div.textContent = text;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 4000);
        }

        function sanitizeData(data) {
            return data.map(item => {
                const clean = {};
                Object.entries(item).forEach(([key, value]) => {
                    if (value !== undefined && value !== '') {
                        clean[key] = value;
                    }
                });
                return clean;
            });
        }

        // Â≠óÂΩ¢Ë£ú‰∏ÅÈ°ØÁ§∫ÈÇèËºØÔºàÂ∞çÈΩä structure.mdÔºâ
        function renderCharacterDisplay(char) {
            if (char.display_image && char.display_image.trim()) {
                return `<img src="${char.display_image.trim()}" class="img-comp" alt="comp" onerror="this.style.display='none';">`;
            }
            if (char.character && typeof char.character === 'string' && char.character.trim().toLowerCase().startsWith('http')) {
                return `<img src="${char.character.trim()}" class="img-comp" alt="comp" onerror="this.style.display='none';">`;
            }
            return char.character || '';
        }

        // Markdown Ê∏≤ÊüìÔºàÂ∞çÈΩä structure.mdÔºâ
        function renderMarkdown(text) {
            if (!text) return '';
            let html = marked.parse(text);
            // ËôïÁêÜÂúñÁâáÂàÜÈ°û
            html = html.replace(
                /<img src="([^"]+)" alt="--Image of: --([^"]+)"/g,
                (match, src, type) => {
                    return `<img src="${src}" class="img-${type}" alt="${type}" loading="lazy">`;
                }
            );
            return html;
        }

        // Èò≤Êäñ‰øùÂ≠ò
        function debounceSave() {
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                saveToFirebase();
            }, 1000);
        }

        // ==================== ËºâÂÖ•Ë≥áÊñô ====================
        async function loadData() {
            const lesson = document.getElementById('lessonSelect').value;

            if (!lesson) {
                currentData = [];
                currentPreviewIndex = -1;
                currentLesson = '';
                // Á¶ÅÁî®Tab
                document.getElementById('tabComponent').disabled = true;
                document.getElementById('tabTarget').disabled = true;
                renderEditPanel();
                renderPreviewPanel();
                return;
            }

            // ÂêØÁî®Tab
            document.getElementById('tabComponent').disabled = false;
            document.getElementById('tabTarget').disabled = false;

            // Â¶ÇÊûúÊ≤°ÊúâÈÄâÊã©Á±ªÂûãÔºå‰ΩøÁî®ÂΩìÂâçÁ±ªÂûãÊàñÈªòËÆ§Á±ªÂûã
            if (!currentType) {
                currentType = 'component';
                updateTabState('component');
            }

            currentLesson = lesson;

            // Âä†ËΩΩÂΩìÂâçÁ±ªÂûãÁöÑÊï∞ÊçÆ
            await loadDataForType(currentType);
        }

        // ==================== Âä†ËΩΩÊåáÂÆöÁ±ªÂûãÁöÑÊï∞ÊçÆ ====================
        async function loadDataForType(type) {
            if (!currentLesson) {
                currentData = [];
                renderEditPanel();
                renderPreviewPanel();
                return;
            }

            currentType = type;

            try {
                const lessonId = currentLesson;
                const doc = await db.collection('lessons').doc(lessonId).get();
                
                if (doc.exists) {
                    const data = doc.data();
                    const fieldName = type === 'component' ? 'components' : 'target_characters';
                    currentData = data[fieldName] || [];
                    
                    // Êåâ order ÊéíÂ∫è
                    currentData.sort((a, b) => (a.order || 0) - (b.order || 0));
                } else {
                    currentData = [];
                }
            } catch (error) {
                showMessage('ËºâÂÖ•Â§±ÊïóÔºö' + error.message, 'error');
                currentData = [];
            }

            renderEditPanel();
            renderPreviewPanel(0); // ÊòæÁ§∫Á¨¨‰∏Ä‰∏™Â≠óÁ¨¶
        }

        // ==================== Êõ¥Êñ∞TabÁä∂ÊÄÅ ====================
        function updateTabState(type) {
            document.querySelectorAll('.type-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const activeTab = document.querySelector(`.type-tab[data-type="${type}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
        }

        // ==================== TabÂàáÊç¢ ====================
        async function switchTypeTab(newType) {
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÈÄâÊã©ËØæÊ¨°
            if (!currentLesson) {
                showMessage('Ë´ãÂÖàÈÅ∏ÊìáË™≤Ê¨°', 'error');
                return;
            }
            
            // Â¶ÇÊûúÁ±ªÂûãÁõ∏ÂêåÔºå‰∏çÂàáÊç¢
            if (currentType === newType) return;
            
            // Ê†áËÆ∞Ê≠£Âú®ÂàáÊç¢ÔºåÈÅøÂÖçÊòæÁ§∫Ëá™Âä®‰øùÂ≠òÊ∂àÊÅØ
            const activeTab = document.querySelector('.type-tab.active');
            if (activeTab) {
                activeTab.classList.add('switching');
            }
            
            // ÊòæÁ§∫‰øùÂ≠òÊèêÁ§∫
            showMessage('üíæ Ê≠£Âú®‰øùÂ≠ò‰∏¶ÂàáÊèõ...', 'info');
            
            try {
                // Á´ãÂç≥‰øùÂ≠òÂΩìÂâçÁ±ªÂûãÁöÑÊï∞ÊçÆÔºàÂº∫Âà∂‰øùÂ≠òÔºâ
                if (saveTimeout) clearTimeout(saveTimeout);
                
                // Âè™ÊúâÂú®ÊúâÂΩìÂâçÁ±ªÂûã‰∏îÊúâÊï∞ÊçÆÊó∂Êâç‰øùÂ≠ò
                if (currentType && currentData.length > 0) {
                    try {
                        await saveToFirebase();
                    } catch (saveError) {
                        console.error('‰øùÂ≠òÂ§±Ë¥•:', saveError);
                        // ‰øùÂ≠òÂ§±Ë¥•‰∏çÂΩ±ÂìçÂàáÊç¢
                    }
                }
                
                // Êõ¥Êñ∞TabÁä∂ÊÄÅ
                updateTabState(newType);
                
                // Âä†ËΩΩÊñ∞Á±ªÂûãÁöÑÊï∞ÊçÆ
                await loadDataForType(newType);
                
                showMessage(`‚úÖ Â∑≤ÂàáÊèõÂà∞${newType === 'component' ? 'ÈÉ®‰ª∂' : 'ÁõÆÊ®ôÂ≠ó'}`, 'success');
            } catch (error) {
                console.error('TabÂàáÊç¢ÈîôËØØ:', error);
                showMessage('ÂàáÊèõÂ§±ÊïóÔºö' + error.message, 'error');
                // Âç≥‰ΩøÂ§±Ë¥•Ôºå‰πüÂ∞ùËØïÊõ¥Êñ∞TabÁä∂ÊÄÅÂíåÂä†ËΩΩÊï∞ÊçÆ
                try {
                    updateTabState(newType);
                    await loadDataForType(newType);
                } catch (loadError) {
                    console.error('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•:', loadError);
                }
            } finally {
                // ÁßªÈô§ÂàáÊç¢Ê†áËÆ∞
                if (activeTab) {
                    activeTab.classList.remove('switching');
                }
            }
        }

        // ==================== ‰øùÂ≠òÂà∞ Firebase ====================
        async function saveToFirebase() {
            if (!currentLesson || !currentType) return;

            const lessonId = currentLesson;
            const fieldName = currentType === 'component' ? 'components' : 'target_characters';

            try {
                const sanitized = sanitizeData(currentData);
                await db.collection('lessons').doc(lessonId).set({
                    [fieldName]: sanitized,
                    meta: {
                        [`${fieldName}_count`]: sanitized.length,
                        last_updated: firebase.firestore.FieldValue.serverTimestamp()
                    }
                }, { merge: true });
                
                // Âè™Âú®ÈùûTabÂàáÊç¢Êó∂ÊòæÁ§∫Ëá™Âä®‰øùÂ≠òÊ∂àÊÅØÔºàÈÅøÂÖçÂπ≤Êâ∞Ôºâ
                const activeTab = document.querySelector('.type-tab.active');
                if (!activeTab || !activeTab.classList.contains('switching')) {
                    showMessage('‚úÖ Â∑≤Ëá™Âãï‰øùÂ≠ò', 'success');
                }
            } catch (error) {
                showMessage('‰øùÂ≠òÂ§±ÊïóÔºö' + error.message, 'error');
                throw error; // ÊäõÂá∫ÈîôËØØ‰ª•‰æøË∞ÉÁî®ËÄÖÂ§ÑÁêÜ
            }
        }

        // ==================== Ê∏≤ÊüìÁ∑®ËºØÈù¢Êùø ====================
        function renderEditPanel() {
            const container = document.getElementById('editPanelContent');
            const emptyState = document.getElementById('emptyEditState');

            if (!container) {
                console.error('editPanelContent not found');
                return;
            }

            if (currentData.length === 0) {
                if (emptyState) emptyState.style.display = 'block';
                container.innerHTML = '';
                return;
            }

            if (emptyState) emptyState.style.display = 'none';
            container.innerHTML = currentData.map((item, index) => createFormItem(item, index)).join('');
            
            // Á∂ÅÂÆö‰∫ã‰ª∂
            attachFormEvents();
        }

        function createFormItem(item, index) {
            const charDisplay = renderCharacterDisplay(item);
            const isPublished = item.is_published !== false;
            return `
                <div class="form-item-card collapsed" data-index="${index}" draggable="true">
                    <div class="form-item-header" onclick="handleFormItemClick(${index})">
                        <span class="form-item-toggle-icon" onclick="event.stopPropagation(); toggleFormItem(${index})">Â±ï</span>
                        <span class="drag-handle" onclick="event.stopPropagation();">‚â°</span>
                        <div class="form-item-preview">${charDisplay || 'Êñ∞È†ÖÁõÆ'}</div>
                        <div class="publish-toggle" onclick="event.stopPropagation();">
                            <label class="toggle-switch">
                                <input type="checkbox" ${isPublished ? 'checked' : ''} onchange="togglePublish(${index}, this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="publish-status ${isPublished ? 'published' : 'unpublished'}">
                                ${isPublished ? 'Â∑≤ÁôºÂ∏É' : 'Êú™ÁôºÂ∏É'}
                            </span>
                        </div>
                    </div>
                    <div class="form-item-body">
                        <div class="form-field required">
                            <label>Â≠ó</label>
                            <input type="text" data-field="character" value="${item.character || ''}" placeholder="‰æãÂ¶ÇÔºöÂ§¨">
                        </div>
                        <div class="form-field">
                            <label>È°ØÁ§∫ÂúñÁâáÔºàÂ≠óÂΩ¢Ë£ú‰∏ÅÔºâ</label>
                            <input type="text" data-field="display_image" value="${item.display_image || ''}" placeholder="https://res.cloudinary.com/...">
                            <small>Áï∂Â≠óÁÑ°Ê≥ïÊ≠£Â∏∏È°ØÁ§∫ÊôÇ‰ΩøÁî®</small>
                        </div>
                        <div class="form-field required">
                            <label>ÊãºÈü≥</label>
                            <input type="text" data-field="pinyin" value="${item.pinyin || ''}" placeholder="‰æãÂ¶ÇÔºögu√†i">
                        </div>
                        <div class="form-field required">
                            <label>ÊÑèÊÄùÔºàËã±ÊñáÔºâ</label>
                            <input type="text" data-field="meaning" value="${item.meaning || ''}" placeholder="‰æãÂ¶ÇÔºöto cut apart / separate">
                        </div>
                        <div class="form-field">
                            <label>ÈÉ®‰ª∂ÊãÜËß£</label>
                            <input type="text" data-field="components_breakdown" value="${item.components_breakdown || ''}" placeholder="‰æãÂ¶ÇÔºö„É¶ + ‰∫∫">
                        </div>
                        <div class="form-field">
                            <label>Êõ∏Êú¨Ëß£ÈáãÔºàÊîØÊè¥ MarkdownÔºâ</label>
                            <textarea data-field="book_explanation" placeholder="ÂèØ‰ΩøÁî® Markdown Ê†ºÂºè...">${item.book_explanation || ''}</textarea>
                        </div>
                        <div class="form-field">
                            <label>Ë®òÊÜ∂ÊïÖ‰∫ãÔºàÊîØÊè¥ MarkdownÔºâ</label>
                            <textarea data-field="story" placeholder="ÂèØ‰ΩøÁî® Markdown Ê†ºÂºè...">${item.story || ''}</textarea>
                        </div>
                        <div class="form-field">
                            <label>ÁôºÈü≥ÊèêÁ§∫ÔºàÊîØÊè¥ MarkdownÔºâ</label>
                            <textarea data-field="pronunciation_cue" placeholder="‰æãÂ¶ÇÔºöSounds like **Gwhy**">${item.pronunciation_cue || ''}</textarea>
                        </div>
                        <div class="form-field">
                            <label>ÂúñÁâáÁ∂≤ÂùÄÔºàËºîÂä©ÊèíÂúñÔºâ</label>
                            <input type="text" data-field="image" value="${item.image || ''}" placeholder="https://res.cloudinary.com/...">
                            <small>ÊïÖ‰∫ãÂúñ„ÄÅË±°ÂΩ¢ÊºîËÆäÂúñÁ≠â</small>
                        </div>
                        <div class="form-field">
                            <label>Ë©ûÁµÑÁØÑ‰æã</label>
                            <textarea data-field="phrases" placeholder="‰æãÂ¶ÇÔºöÂàöÊâç gƒÅngc√°i (just now)">${item.phrases || ''}</textarea>
                        </div>
                        <div class="form-field">
                            <label>Ë®òÊÜ∂‰æãÂè•</label>
                            <input type="text" data-field="example" value="${item.example || ''}" placeholder="‰æãÂ¶ÇÔºöCOW needs a TOWEL">
                        </div>
                        <div class="form-field">
                            <label>ÊéíÂ∫è</label>
                            <input type="number" data-field="order" value="${item.order || index}" min="0">
                        </div>
                        <button class="btn-delete-item" onclick="deleteItem(${index})">üóëÔ∏è Âà™Èô§Ê≠§È†ÖÁõÆ</button>
                    </div>
                </div>
            `;
        }

        function toggleFormItem(index) {
            const card = document.querySelector(`.form-item-card[data-index="${index}"]`);
            if (card) {
                card.classList.toggle('collapsed');
                card.classList.toggle('expanded');
                // Êõ¥Êñ∞ÊåâÈíÆÊñáÂ≠ó
                const toggleIcon = card.querySelector('.form-item-toggle-icon');
                if (toggleIcon) {
                    toggleIcon.textContent = card.classList.contains('expanded') ? 'Êî∂' : 'Â±ï';
                }
            }
        }

        function expandAllItems() {
            document.querySelectorAll('.form-item-card').forEach(card => {
                card.classList.remove('collapsed');
                card.classList.add('expanded');
                const toggleIcon = card.querySelector('.form-item-toggle-icon');
                if (toggleIcon) {
                    toggleIcon.textContent = 'Êî∂';
                }
            });
            showMessage('Â∑≤Â±ïÈñãÊâÄÊúâÈ†ÖÁõÆ', 'success');
        }

        function collapseAllItems() {
            document.querySelectorAll('.form-item-card').forEach(card => {
                card.classList.remove('expanded');
                card.classList.add('collapsed');
                const toggleIcon = card.querySelector('.form-item-toggle-icon');
                if (toggleIcon) {
                    toggleIcon.textContent = 'Â±ï';
                }
            });
            showMessage('Â∑≤ÊäòÁñäÊâÄÊúâÈ†ÖÁõÆ', 'success');
        }

        function togglePublish(index, checked) {
            if (!currentData[index]) return;
            
            currentData[index].is_published = checked;
            
            // Êõ¥Êñ∞ÁãÄÊÖãÊñáÂ≠óÈ°ØÁ§∫
            const statusText = document.querySelector(`.form-item-card[data-index="${index}"] .publish-status`);
            if (statusText) {
                if (checked) {
                    statusText.classList.add('published');
                    statusText.classList.remove('unpublished');
                    statusText.textContent = 'Â∑≤ÁôºÂ∏É';
                } else {
                    statusText.classList.remove('published');
                    statusText.classList.add('unpublished');
                    statusText.textContent = 'Êú™ÁôºÂ∏É';
                }
            }
            
            debounceSave();
            renderPreviewPanel(currentPreviewIndex >= 0 ? currentPreviewIndex : 0);
            showMessage(checked ? 'Â∑≤ÁôºÂ∏É' : 'Â∑≤ÂèñÊ∂àÁôºÂ∏É', 'success');
        }

        // ==================== Êï¥Ë™≤ÁôºÂ∏É/ÂèñÊ∂àÁôºÂ∏É ====================
        async function publishAll() {
            if (!currentLesson) {
                showMessage('Ë´ãÂÖàÈÅ∏ÊìáË™≤Ê¨°', 'error');
                return;
            }

            if (currentData.length === 0) {
                showMessage('Ê≤íÊúâÂèØÁôºÂ∏ÉÁöÑÈ†ÖÁõÆ', 'error');
                return;
            }

            if (!confirm(`Á¢∫ÂÆöË¶ÅÁôºÂ∏ÉÊú¨Ë™≤ÁöÑÊâÄÊúâ ${currentData.length} ÂÄãÈ†ÖÁõÆÂóéÔºü`)) {
                return;
            }

            // ÊâπÈáèË®≠ÁΩÆÊâÄÊúâÈ†ÖÁõÆÁÇ∫Â∑≤ÁôºÂ∏É
            currentData.forEach((item, index) => {
                item.is_published = true;
                
                // Êõ¥Êñ∞UI‰∏≠ÁöÑcheckboxÂíåÁãÄÊÖãÊñáÂ≠ó
                const card = document.querySelector(`.form-item-card[data-index="${index}"]`);
                if (card) {
                    const checkbox = card.querySelector('input[type="checkbox"]');
                    const statusText = card.querySelector('.publish-status');
                    
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                    
                    if (statusText) {
                        statusText.classList.add('published');
                        statusText.classList.remove('unpublished');
                        statusText.textContent = 'Â∑≤ÁôºÂ∏É';
                    }
                }
            });

            // Á´ãÂç≥‰øùÂ≠òÂà∞ FirebaseÔºà‰∏ç‰ΩøÁî®Èò≤ÊäñÔºâ
            if (saveTimeout) clearTimeout(saveTimeout);
            await saveToFirebase();
            
            showMessage(`‚úÖ Â∑≤ÁôºÂ∏É ${currentData.length} ÂÄãÈ†ÖÁõÆ`, 'success');
        }

        async function unpublishAll() {
            if (!currentLesson) {
                showMessage('Ë´ãÂÖàÈÅ∏ÊìáË™≤Ê¨°', 'error');
                return;
            }

            if (currentData.length === 0) {
                showMessage('Ê≤íÊúâÂèØÂèñÊ∂àÁôºÂ∏ÉÁöÑÈ†ÖÁõÆ', 'error');
                return;
            }

            if (!confirm(`Á¢∫ÂÆöË¶ÅÂèñÊ∂àÁôºÂ∏ÉÊú¨Ë™≤ÁöÑÊâÄÊúâ ${currentData.length} ÂÄãÈ†ÖÁõÆÂóéÔºü`)) {
                return;
            }

            // ÊâπÈáèË®≠ÁΩÆÊâÄÊúâÈ†ÖÁõÆÁÇ∫Êú™ÁôºÂ∏É
            currentData.forEach((item, index) => {
                item.is_published = false;
                
                // Êõ¥Êñ∞UI‰∏≠ÁöÑcheckboxÂíåÁãÄÊÖãÊñáÂ≠ó
                const card = document.querySelector(`.form-item-card[data-index="${index}"]`);
                if (card) {
                    const checkbox = card.querySelector('input[type="checkbox"]');
                    const statusText = card.querySelector('.publish-status');
                    
                    if (checkbox) {
                        checkbox.checked = false;
                    }
                    
                    if (statusText) {
                        statusText.classList.remove('published');
                        statusText.classList.add('unpublished');
                        statusText.textContent = 'Êú™ÁôºÂ∏É';
                    }
                }
            });

            // Á´ãÂç≥‰øùÂ≠òÂà∞ FirebaseÔºà‰∏ç‰ΩøÁî®Èò≤ÊäñÔºâ
            if (saveTimeout) clearTimeout(saveTimeout);
            await saveToFirebase();
            
            showMessage(`‚ùå Â∑≤ÂèñÊ∂àÁôºÂ∏É ${currentData.length} ÂÄãÈ†ÖÁõÆ`, 'success');
        }

        // ÁÇπÂáªÂ≠óÂç°Â§¥ÈÉ®Êó∂ÁöÑÂ§ÑÁêÜ
        function handleFormItemClick(index) {
            const now = Date.now();
            const card = document.querySelector(`.form-item-card[data-index="${index}"]`);
            
            if (!card) return;
            
            // Â¶ÇÊûúÊòØÂêå‰∏Ä‰∏™Â≠óÂç°‰∏îÂú®300msÂÜÖÁÇπÂáªÔºåËßÜ‰∏∫ÂèåÂáªÔºåÂ±ïÂºÄË°®Âçï
            if (lastClickIndex === index && (now - lastClickTime) < 300) {
                // Á¨¨‰∫åÊ¨°ÁÇπÂáªÔºöÂ±ïÂºÄË°®Âçï
                toggleFormItem(index);
                lastClickIndex = -1;
                lastClickTime = 0;
            } else {
                // Á¨¨‰∏ÄÊ¨°ÁÇπÂáªÔºöÂè™ÊòæÁ§∫È¢ÑËßàÂíåÊªöÂä®Ôºå‰∏çÂ±ïÂºÄË°®Âçï
                lastClickIndex = index;
                lastClickTime = now;
                
                // È´ò‰∫ÆÈ°ØÁ§∫
                card.classList.add('highlighted');
                // ÁßªÈô§ÂÖ∂‰ªñÂç°ÁâáÁöÑÈ´ò‰∫Æ
                document.querySelectorAll('.form-item-card').forEach(c => {
                    if (c !== card) c.classList.remove('highlighted');
                });
                // ÊªæÂãïÂà∞Ë©≤‰ΩçÁΩÆ
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // 3ÁßíÂæåÁßªÈô§È´ò‰∫Æ
                setTimeout(() => {
                    card.classList.remove('highlighted');
                }, 3000);
                
                // Êõ¥Êñ∞Âè≥‰æßÈ¢ÑËßà
                renderPreviewPanel(index);
            }
        }

        function scrollToFormItem(index) {
            const card = document.querySelector(`.form-item-card[data-index="${index}"]`);
            if (card) {
                // Â±ïÈñãÂç°Áâá
                card.classList.remove('collapsed');
                card.classList.add('expanded');
                // Êõ¥Êñ∞ÊåâÈíÆÊñáÂ≠ó
                const toggleIcon = card.querySelector('.form-item-toggle-icon');
                if (toggleIcon) {
                    toggleIcon.textContent = 'Êî∂';
                }
                // È´ò‰∫ÆÈ°ØÁ§∫
                card.classList.add('highlighted');
                // ÁßªÈô§ÂÖ∂‰ªñÂç°ÁâáÁöÑÈ´ò‰∫Æ
                document.querySelectorAll('.form-item-card').forEach(c => {
                    if (c !== card) c.classList.remove('highlighted');
                });
                // ÊªæÂãïÂà∞Ë©≤‰ΩçÁΩÆ
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // 3ÁßíÂæåÁßªÈô§È´ò‰∫Æ
                setTimeout(() => {
                    card.classList.remove('highlighted');
                }, 3000);
                
                // Êõ¥Êñ∞Âè≥‰æßÈ¢ÑËßà
                renderPreviewPanel(index);
            }
        }

        function attachFormEvents() {
            document.querySelectorAll('.form-item-card input, .form-item-card textarea, .form-item-card select').forEach(input => {
                input.addEventListener('input', function() {
                    const card = this.closest('.form-item-card');
                    const index = parseInt(card.dataset.index);
                    const field = this.dataset.field;
                    const value = this.type === 'checkbox' ? this.checked : this.value;
                    
                    if (!currentData[index]) return;
                    
                    // ÁßªÈô§ is_published ÁöÑËôïÁêÜÔºåÂõ†ÁÇ∫ÁèæÂú®Áî®ÊåâÈàïËôïÁêÜ
                    if (field !== 'is_published') {
                        currentData[index][field] = value;
                    }
                    
                    // Â¶ÇÊûú‰øÆÊîπÁöÑÊòØ character Êàñ display_imageÔºåÊõ¥Êñ∞È†êË¶Ω
                    if (field === 'character' || field === 'display_image') {
                        const preview = card.querySelector('.form-item-preview');
                        if (preview) {
                            const item = currentData[index];
                            preview.innerHTML = renderCharacterDisplay(item) || 'Êñ∞È†ÖÁõÆ';
                        }
                    }
                    
                    debounceSave();
                    // Â¶ÇÊûú‰øÆÊîπÁöÑÊòØÂΩìÂâçÈ¢ÑËßàÁöÑÂ≠óÁ¨¶ÔºåÊõ¥Êñ∞È¢ÑËßà
                    if (index === currentPreviewIndex) {
                        renderPreviewPanel(index);
                    }
                });
            });
        }

        // ==================== Êñ∞Â¢ûÈ†ÖÁõÆ ====================
        function addItem() {
            if (!currentLesson) {
                showMessage('Ë´ãÂÖàÈÅ∏ÊìáË™≤Ê¨°', 'error');
                return;
            }

            const newItem = {
                character: '',
                pinyin: '',
                meaning: '',
                is_published: false,
                order: currentData.length
            };

            currentData.push(newItem);
            renderEditPanel();
            // Ëá™ÂãïÂ±ïÈñãÊñ∞È†ÖÁõÆ‰∏¶È°ØÁ§∫È†êË¶Ω
            setTimeout(() => {
                scrollToFormItem(currentData.length - 1);
            }, 100);
            showMessage('Â∑≤Êñ∞Â¢ûÈ†ÖÁõÆ', 'success');
        }

        // ==================== Âà™Èô§È†ÖÁõÆ ====================
        function deleteItem(index) {
            if (!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§È†ÖÁõÆÔºü')) return;
            
            // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÈ¢ÑËßàÁöÑÂ≠óÁ¨¶ÔºåÂàáÊç¢Âà∞Á¨¨‰∏Ä‰∏™Â≠óÁ¨¶
            if (index === currentPreviewIndex) {
                currentPreviewIndex = 0;
            } else if (index < currentPreviewIndex) {
                currentPreviewIndex--;
            }
            
            currentData.splice(index, 1);
            // ÈáçÊñ∞ÊéíÂ∫è
            currentData.forEach((item, i) => {
                item.order = i;
            });
            
            debounceSave();
            renderEditPanel();
            renderPreviewPanel(currentPreviewIndex >= 0 && currentData.length > 0 ? currentPreviewIndex : 0);
            showMessage('Â∑≤Âà™Èô§', 'success');
        }

        // ==================== Ê∏≤ÊüìÈ†êË¶ΩÈù¢Êùø ====================
        let currentPreviewIndex = -1;

        function renderPreviewPanel(index = null) {
            const container = document.getElementById('previewPanelContent');
            const emptyState = document.getElementById('emptyPreviewState');

            if (!container) return;

            if (currentData.length === 0) {
                if (emptyState) emptyState.style.display = 'block';
                container.innerHTML = '';
                return;
            }

            // Â¶ÇÊûúÊåáÂÆö‰∫ÜindexÔºåÊòæÁ§∫ËØ•Â≠óÁ¨¶ÔºõÂê¶ÂàôÊòæÁ§∫ÂΩìÂâçÈÄâ‰∏≠ÁöÑÂ≠óÁ¨¶
            const displayIndex = index !== null ? index : (currentPreviewIndex >= 0 ? currentPreviewIndex : 0);
            currentPreviewIndex = displayIndex;
            const item = currentData[displayIndex];

            if (!item) {
                if (emptyState) emptyState.style.display = 'block';
                container.innerHTML = '';
                return;
            }

            if (emptyState) emptyState.style.display = 'none';
            
            // Â≠óÂΩ¢Ë£ú‰∏ÅÁ≥ªÁµ±
            let charDisplay = item.character || '';
            if (item.display_image && item.display_image.trim()) {
                charDisplay = `<img src="${item.display_image.trim()}" class="img-comp" alt="comp" onerror="this.style.display='none';">`;
            } else if (item.character && typeof item.character === 'string' && item.character.trim().toLowerCase().startsWith('http')) {
                charDisplay = `<img src="${item.character.trim()}" class="img-comp" alt="comp" onerror="this.style.display='none';">`;
            }

            let html = `
                <div class="preview-display">
                    <div class="character">${charDisplay}</div>
            `;

            // ÊãºÈü≥
            if (item.pinyin) {
                html += `<div class="pinyin">${item.pinyin}</div>`;
            }

            // ÊÑèÊÄù
            if (item.meaning) {
                html += `<div class="meaning">${item.meaning}</div>`;
            }

            // ÈÉ®‰ª∂ÊãÜËß£
            if (item.components_breakdown) {
                const processedBreakdown = processMarkdownImages(marked.parse(item.components_breakdown));
                html += `<div class="breakdown">${processedBreakdown}</div>`;
            }

            // ÂúñÁâáÔºàËºîÂä©ÊèíÂúñÔºâ
            if (item.image && item.image.trim()) {
                html += `<img src="${item.image.trim()}" class="preview-image" alt="${item.character || 'ËºîÂä©ÊèíÂúñ'}" onerror="this.style.display='none'">`;
            }

            // Êõ∏Êú¨Ëß£Èáã
            if (item.book_explanation) {
                const processedExplanation = processMarkdownImages(marked.parse(item.book_explanation));
                html += `
                    <div class="preview-section">
                        <div class="preview-section-title">üìñ Ëß£Èáã</div>
                        <div class="preview-section-content markdown-content">${processedExplanation}</div>
                    </div>
                `;
            }

            // Ë®òÊÜ∂ÊïÖ‰∫ã
            if (item.story) {
                const processedStory = processMarkdownImages(marked.parse(item.story));
                html += `
                    <div class="preview-section">
                        <div class="preview-section-title">üß† Ë®òÊÜ∂ÊïÖ‰∫ã</div>
                        <div class="preview-section-content markdown-content">${processedStory}</div>
                    </div>
                `;
            }

            // ÁôºÈü≥ÊèêÁ§∫
            if (item.pronunciation_cue) {
                const processedPronunciation = processMarkdownImages(marked.parse(item.pronunciation_cue));
                html += `
                    <div class="preview-section">
                        <div class="preview-section-title">üîä ÁôºÈü≥ÊèêÁ§∫</div>
                        <div class="preview-section-content markdown-content">${processedPronunciation}</div>
                    </div>
                `;
            }

            // Ë©ûÁµÑÁØÑ‰æã
            if (item.phrases) {
                const processedPhrases = processMarkdownImages(marked.parse(item.phrases));
                html += `
                    <div class="preview-section">
                        <div class="preview-section-title">üí¨ Ë©ûÁµÑÁØÑ‰æã</div>
                        <div class="preview-section-content markdown-content">${processedPhrases}</div>
                    </div>
                `;
            }

            // ‰æãÂè•
            if (item.example) {
                html += `
                    <div class="preview-section">
                        <div class="preview-section-title">üí° ‰æãÂè•</div>
                        <div class="preview-section-content markdown-content">${item.example}</div>
                    </div>
                `;
            }

            html += `</div>`;
            container.innerHTML = html;
            
            // ÊªöÂä®Âà∞È°∂ÈÉ®
            container.scrollTop = 0;
        }

        // Â§ÑÁêÜ Markdown ÂõæÁâáÂàÜÁ±ªÔºàÁ±ª‰ºº lesson-presentation.htmlÔºâ
        function processMarkdownImages(htmlContent) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            const images = tempDiv.querySelectorAll('img');
            images.forEach(img => {
                const alt = (img.getAttribute('alt') || '').toLowerCase();
                if (alt.includes('comp')) {
                    img.className = 'img-comp';
                } else if (alt.includes('origin')) {
                    img.className = 'img-origin';
                } else if (alt.includes('story')) {
                    img.className = 'img-story';
                }
                img.setAttribute('onerror', "this.style.display='none'");
            });
            return tempDiv.innerHTML;
        }


        // ==================== ÊãñÊãΩÊéíÂ∫è ====================
        function initDragAndDrop() {
            const container = document.getElementById('editPanelContent');
            
            container.addEventListener('dragstart', (e) => {
                if (e.target.closest('.form-item-card')) {
                    draggedElement = e.target.closest('.form-item-card');
                    draggedElement.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                }
            });

            container.addEventListener('dragend', (e) => {
                if (draggedElement) {
                    draggedElement.classList.remove('dragging');
                    draggedElement = null;
                }
            });

            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(container, e.clientY);
                const dragging = document.querySelector('.dragging');
                if (dragging && afterElement == null) {
                    container.appendChild(dragging);
                } else if (dragging && afterElement) {
                    container.insertBefore(dragging, afterElement);
                }
            });

            container.addEventListener('drop', (e) => {
                e.preventDefault();
                if (draggedElement) {
                    const newIndex = Array.from(container.children).indexOf(draggedElement);
                    const oldIndex = parseInt(draggedElement.dataset.index);
                    
                    // Êõ¥Êñ∞Ë≥áÊñôÈ†ÜÂ∫è
                    const [movedItem] = currentData.splice(oldIndex, 1);
                    currentData.splice(newIndex, 0, movedItem);
                    
                    // Êõ¥Êñ∞ order
                    currentData.forEach((item, i) => {
                        item.order = i;
                    });
                    
                    debounceSave();
                    renderEditPanel();
                    renderPreviewPanel(currentPreviewIndex >= 0 ? currentPreviewIndex : 0);
                }
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.form-item-card:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // ==================== Èù¢ÊùøÂØ¨Â∫¶Ë™øÊï¥ ====================
        function initResizer() {
            const resizer = document.getElementById('resizer');
            const editPanel = document.getElementById('editPanel');
            let isResizing = false;

            resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                resizer.classList.add('resizing');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;

                const containerRect = document.querySelector('.studio-container').getBoundingClientRect();
                const newWidth = ((e.clientX - containerRect.left) / containerRect.width) * 100;
                
                if (newWidth >= 5 && newWidth <= 60) {
                    editPanel.style.width = `${newWidth}%`;
                }
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    resizer.classList.remove('resizing');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        }

        // ==================== ÂàáÊèõÁ∑®ËºØÈù¢Êùø ====================
        function initToggleEdit() {
            const btn = document.getElementById('btnToggleEdit');
            const editPanel = document.getElementById('editPanel');

            btn.addEventListener('click', () => {
                editPanel.classList.toggle('collapsed');
                btn.textContent = editPanel.classList.contains('collapsed') ? '‚ñ∂' : '‚óÄ';
            });
        }


        // ==================== ÂàùÂßãÂåñ ====================
        // TabÂàáÊç¢‰∫ã‰ª∂
        document.querySelectorAll('.type-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                if (!tab.disabled) {
                    const type = tab.dataset.type;
                    switchTypeTab(type);
                }
            });
        });
        
        document.getElementById('lessonSelect').addEventListener('change', loadData);
        document.getElementById('btnAdd').addEventListener('click', addItem);
        document.getElementById('btnExpandAll').addEventListener('click', expandAllItems);
        document.getElementById('btnCollapseAll').addEventListener('click', collapseAllItems);
        document.getElementById('btnPublishAll').addEventListener('click', publishAll);
        document.getElementById('btnUnpublishAll').addEventListener('click', unpublishAll);
        initResizer();
        initToggleEdit();
        initDragAndDrop();

        // ËºâÂÖ•ÂÖ®ÂüüÂ∞éËà™ËÖ≥Êú¨
        const navScript = document.createElement('script');
        navScript.src = '../../assets/js/nav-global.js';
        document.body.appendChild(navScript);
    </script>
</body>
</html>
