<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰¹é‡å¯¼å…¥è¯†å­—1-16æ•°æ®åˆ°Firebase</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .file-upload {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }
        
        input[type="file"] {
            display: block;
            width: 100%;
            padding: 10px;
            border: 2px dashed #667eea;
            border-radius: 8px;
            background: #f8f9fa;
            cursor: pointer;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .log {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            display: none;
        }
        
        .log.active {
            display: block;
        }
        
        .log-item {
            padding: 4px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .log-item:last-child {
            border-bottom: none;
        }
        
        .success {
            color: #28a745;
        }
        
        .error {
            color: #dc3545;
        }
        
        .info {
            color: #667eea;
        }
        
        .warning {
            color: #ffc107;
        }
        
        .progress {
            margin-top: 20px;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            display: none;
        }
        
        .progress.active {
            display: block;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ æ‰¹é‡å¯¼å…¥è¯†å­—1-16æ•°æ®</h1>
        <p class="subtitle">å°†CSVæ•°æ®ä¸€æ¬¡æ€§å¯¼å…¥åˆ°Firebase Firestore</p>
        
        <div class="file-upload">
            <label for="targetFile">ğŸ“ ç›®æ ‡å­— CSV (lesson1-16_target_characters.csv)</label>
            <input type="file" id="targetFile" accept=".csv">
        </div>
        
        <div class="file-upload">
            <label for="componentFile">ğŸ§© éƒ¨ä»¶ CSV (lesson1-16_components.csv)</label>
            <input type="file" id="componentFile" accept=".csv">
        </div>
        
        <button class="btn" id="importBtn" disabled>å¼€å§‹å¯¼å…¥</button>
        
        <div class="progress" id="progress">
            <div class="progress-bar" id="progressBar">0%</div>
        </div>
        
        <div class="log" id="log"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
    apiKey: "AIzaSyDMDTDwDP0mEXwgJdwsXVMB2IFi9Q5zfyU",
    authDomain: "shizi-with-elisa.firebaseapp.com",
    projectId: "shizi-with-elisa",
    storageBucket: "shizi-with-elisa.firebasestorage.app",
    messagingSenderId: "46368268308",
    appId: "1:46368268308:web:5847aeb7b239b16d624701"
};

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let targetData = null;
        let componentData = null;

        // ç›‘å¬æ–‡ä»¶é€‰æ‹©
        document.getElementById('targetFile').addEventListener('change', (e) => {
            readCSV(e.target.files[0], 'target');
        });

        document.getElementById('componentFile').addEventListener('change', (e) => {
            readCSV(e.target.files[0], 'component');
        });

        // è¯»å– CSV æ–‡ä»¶
        function readCSV(file, type) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const data = parseCSV(text);
                
                if (type === 'target') {
                    targetData = data;
                    log(`âœ… ç›®æ ‡å­—CSVè¯»å–æˆåŠŸï¼š${data.length} æ¡è®°å½•`, 'success');
                } else {
                    componentData = data;
                    log(`âœ… éƒ¨ä»¶CSVè¯»å–æˆåŠŸï¼š${data.length} æ¡è®°å½•`, 'success');
                }
                
                // æ£€æŸ¥æ˜¯å¦ä¸¤ä¸ªæ–‡ä»¶éƒ½å·²åŠ è½½
                if (targetData && componentData) {
                    document.getElementById('importBtn').disabled = false;
                }
            };
            reader.readAsText(file);
        }

        // è§£æ CSV
        function parseCSV(text) {
            const lines = text.split('\n').filter(line => line.trim());
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length === headers.length) {
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = values[index].trim().replace(/^"|"$/g, '');
                    });
                    data.push(obj);
                }
            }
            
            return data;
        }

        // è§£æ CSV è¡Œï¼ˆå¤„ç†å¼•å·å†…çš„é€—å·ï¼‰
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            
            return result;
        }

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            logDiv.classList.add('active');
            
            const item = document.createElement('div');
            item.className = `log-item ${type}`;
            item.textContent = message;
            logDiv.appendChild(item);
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(current, total) {
            const percent = Math.round((current / total) * 100);
            const progressDiv = document.getElementById('progress');
            const progressBar = document.getElementById('progressBar');
            
            progressDiv.classList.add('active');
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
        }

        // å¼€å§‹å¯¼å…¥
        document.getElementById('importBtn').addEventListener('click', async () => {
            document.getElementById('importBtn').disabled = true;
            document.getElementById('log').innerHTML = '';
            
            log('ğŸš€ å¼€å§‹æ‰¹é‡å¯¼å…¥...', 'info');
            
            try {
                // 1. ç»„ç»‡æ•°æ®ï¼šæŒ‰è¯¾ç¨‹åˆ†ç»„
                const lessonMap = {};
                
                // å¤„ç†ç›®æ ‡å­—
                targetData.forEach(item => {
                    const lessonId = item.lesson_id; // lesson1, lesson2, ...
                    if (!lessonMap[lessonId]) {
                        lessonMap[lessonId] = {
                            target_characters: [],
                            components: []
                        };
                    }
                    lessonMap[lessonId].target_characters.push({
                        character: item.character,
                        pinyin: item.pinyin,
                        meaning: item.meaning
                    });
                });
                
                // å¤„ç†éƒ¨ä»¶
                componentData.forEach(item => {
                    const lessonId = item.lesson_id; // components-lesson1, components-lesson2, ...
                    // æå–è¯¾ç¨‹ç¼–å·
                    const match = lessonId.match(/lesson(\d+)/);
                    if (match) {
                        const actualLessonId = 'lesson' + match[1];
                        if (!lessonMap[actualLessonId]) {
                            lessonMap[actualLessonId] = {
                                target_characters: [],
                                components: []
                            };
                        }
                        lessonMap[actualLessonId].components.push({
                            character: item.character,
                            pinyin: item.pinyin,
                            meaning: item.meaning
                        });
                    }
                });
                
                log(`ğŸ“Š æ•°æ®æ•´ç†å®Œæˆï¼Œå…± ${Object.keys(lessonMap).length} ä¸ªè¯¾ç¨‹`, 'success');
                
                // 2. æ‰¹é‡å†™å…¥ Firebase
                const lessons = Object.keys(lessonMap).sort((a, b) => {
                    const numA = parseInt(a.replace('lesson', ''));
                    const numB = parseInt(b.replace('lesson', ''));
                    return numA - numB;
                });
                
                let completed = 0;
                const total = lessons.length;
                
                for (const lessonId of lessons) {
                    const data = lessonMap[lessonId];
                    
                    try {
                        // è¯»å–ç°æœ‰æ•°æ®
                        const docRef = db.collection('lessons').doc(lessonId);
                        const docSnap = await docRef.get();
                        
                        let updateData = {};
                        
                       if (docSnap.exists) { 
                            // åˆå¹¶æ¨¡å¼ï¼šä¿ç•™ç°æœ‰æ•°æ®
                            const existingData = docSnap.data();
                            updateData = {
                                ...existingData,
                                target_characters: data.target_characters,
                                components: data.components
                            };
                            log(`ğŸ“ æ›´æ–° ${lessonId}ï¼š${data.target_characters.length} ä¸ªç›®æ ‡å­—ï¼Œ${data.components.length} ä¸ªéƒ¨ä»¶`, 'info');
                        } else {
                            // æ–°å»º
                            updateData = {
                                target_characters: data.target_characters,
                                components: data.components,
                                meta: {
                                    created_at: firebase.firestore.FieldValue.serverTimestamp(),
                                    updated_at: firebase.firestore.FieldValue.serverTimestamp()
                                }
                            };
                            log(`âœ¨ åˆ›å»º ${lessonId}ï¼š${data.target_characters.length} ä¸ªç›®æ ‡å­—ï¼Œ${data.components.length} ä¸ªéƒ¨ä»¶`, 'info');
                        }
                        
                        await docRef.set(updateData, { merge: true });
                        
                        completed++;
                        updateProgress(completed, total);
                        
                        log(`âœ… ${lessonId} å¯¼å…¥æˆåŠŸ`, 'success');
                        
                    } catch (error) {
                        log(`âŒ ${lessonId} å¯¼å…¥å¤±è´¥ï¼š${error.message}`, 'error');
                    }
                    
                    // å»¶è¿Ÿé¿å…é€Ÿç‡é™åˆ¶
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                
                log('', 'info');
                log('ğŸ‰ æ‰€æœ‰æ•°æ®å¯¼å…¥å®Œæˆï¼', 'success');
                log(`ğŸ“Š æˆåŠŸå¯¼å…¥ ${completed}/${total} ä¸ªè¯¾ç¨‹`, 'success');
                
            } catch (error) {
                log(`âŒ å¯¼å…¥è¿‡ç¨‹å‡ºé”™ï¼š${error.message}`, 'error');
                console.error(error);
            } finally {
                document.getElementById('importBtn').disabled = false;
            }
        });
    </script>
</body>
</html>